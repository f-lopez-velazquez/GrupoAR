<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Generador de Cotizaciones – Grupo AR</title>
  <style>
    :root {
      --azul: #0a6ec8;
      --rojo: #dc1e28;
      --gris-fondo: #f6f8fa;
      --input-borde: #c5d5eb;
      --input-focus: #88b8f5;
      --txt: #253250;
    }
    body {
      background: var(--gris-fondo);
      font-family: 'Helvetica Neue', Arial, sans-serif;
      color: var(--txt);
      margin: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      margin: 0 auto 30px auto;
      padding: 12px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 12px 0 18px 0;
      justify-content: center;
    }
    header img { height: 42px; border-radius: 7px; box-shadow: 0 1px 8px #e7eefa;}
    header .logoTitle {
      font-size: 1.47em;
      font-weight: 700;
      letter-spacing: 0.5px;
      color: var(--azul);
      line-height: 1;
    }
    header .logoTitle span { color: var(--rojo);}
    .form-container, .preview-container {
      background: #fff;
      border-radius: 13px;
      box-shadow: 0 2px 16px rgba(10,110,200,0.08);
      padding: 22px 12px 23px 12px;
      margin-bottom: 20px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 8px;
    }
    .form-col {
      flex: 1 1 220px;
      min-width: 180px;
      margin-bottom: 6px;
    }
    label {
      font-weight: 500;
      color: var(--azul);
      display: block;
      font-size: 1.05em;
      margin-bottom: 4px;
    }
    .input-wrap {
      position: relative;
      margin-bottom: 6px;
    }
    input, textarea, select {
      width: 100%;
      box-sizing: border-box;
      border: 2px solid var(--input-borde);
      border-radius: 8px;
      font-size: 1.1em;
      padding: 12px 12px 12px 12px;
      background: #fafcff;
      color: var(--txt);
      outline: none;
      transition: border-color 0.18s;
      margin-bottom: 0;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--input-focus);
      background: #fff;
    }
    .btn-small-row {
      display: flex;
      gap: 7px;
      margin-top: 5px;
    }
    .btn-micro, .btn-correct {
      background: #eaf3fc;
      color: var(--azul);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.14s;
    }
    .btn-correct {
      background: #eafcf1;
      color: #009e47;
    }
    .btn-micro:hover { background: #d1eaff;}
    .btn-correct:hover { background: #c5ffe5;}
    @media (max-width: 640px) {
      .container { padding: 2vw;}
      .form-row { flex-direction: column; gap: 3px;}
      .form-col { min-width: 98px;}
      input, textarea, select { font-size: 1em; padding: 11px 10px;}
      .form-container, .preview-container { padding: 13px 4px 16px 4px;}
    }
    h3 { font-size: 1.1em; color: var(--azul);}
    .details-btn, #addItemBtn, #generateBtn, #shareBtn, #addDetalleBtn {
      background: linear-gradient(90deg, var(--azul), var(--rojo) 75%);
      color: #fff;
      font-size: 1.08em;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      letter-spacing: .2px;
      margin: 12px 0 0 0;
      padding: 13px 0;
      cursor: pointer;
      width: 100%;
      transition: background 0.14s, transform 0.09s;
      box-shadow: 0 2px 8px #b6cde94d;
    }
    .details-btn:active, #addItemBtn:active, #generateBtn:active, #shareBtn:active, #addDetalleBtn:active {
      transform: scale(.97);
    }
    .table-scroll { overflow-x: auto; border-radius: 8px;}
    table { width: 100%; border-collapse: collapse; margin-top: 11px;}
    th, td { padding: 10px 7px; border: 1.4px solid #e3e8ef; font-size: 1em;}
    th {
      background: linear-gradient(90deg, #e8f2fb 75%, #f9e8ea 100%);
      color: var(--azul); font-weight: 700;
    }
    tr:nth-child(even) { background: #f5faff;}
    .remove-btn {
      background: none; border: none; color: #c00; font-size: 1.19em; cursor: pointer;
      transition: color 0.12s;
    }
    .remove-btn:hover { color: #d70022;}
    .summary { margin-top: 13px; text-align: right; font-size: 1.07em; color: #384357;}
    .summary div { margin-bottom: 4px;}
    #previewResponsive {
      min-height: 140px; border: 1.1px solid #d8e8f4;
      border-radius: 8px; padding: 12px; background: #f8fafc;
      margin-bottom: 11px;
      font-size: 1.06em;
    }
    /* Sidebar/drawer ultra elegante */
    .sidebar {
      position: fixed; top: 0; right: 0; width: 325px; max-width: 99vw; height: 100vh;
      background: #fff; box-shadow: -2px 0 22px #0a6ec815;
      z-index: 999;
      transition: transform 0.34s cubic-bezier(.44,0,.2,1);
      padding: 25px 16px 19px 18px; border-radius: 13px 0 0 13px;
      overflow-y: auto; will-change: transform;
      transform: translateX(100%);
      pointer-events: none; display: block;
    }
    .sidebar.open { transform: translateX(0); pointer-events: auto;}
    .sidebar.closed { transform: translateX(100%); pointer-events: none;}
    .sidebar h4 { color: var(--azul); margin-bottom: 14px;}
    .sidebar label {
      display: flex; align-items: center; gap: 8px;
      font-weight: 450;
      margin-bottom: 10px;
      cursor: pointer;
      font-size: 1.01em; color: #374569;
    }
    .sidebar textarea {
      margin-top: 6px; min-height: 39px; background: #f4f8fd;
      border: 2px solid var(--input-borde);
      font-size: 1.04em;
      margin-bottom: 4px;
      border-radius: 7px;
      transition: border-color .13s;
    }
    .sidebar-close {
      background: none; border: none; color: var(--azul); font-size: 1.5em; position: absolute; top: 8px; right: 12px; cursor: pointer;
      border-radius: 6px;
    }
    .detalles-agregados {
      margin: 10px 0 0 0; padding: 0; list-style: disc; color: #384357; font-size: 1.04em;
    }
    .detalles-agregados li {
      margin: 3px 0; display: flex; align-items: center; justify-content: space-between; gap: 7px;
      background: #f7fcff; padding: 5px 8px; border-radius: 5px;
    }
    .detalles-agregados .del-detalle {
      color: #c00; background:none; border:none; font-size:1.12em; cursor:pointer;
      margin-left: 8px; border-radius: 5px;
    }
    @media (max-width: 650px) {
      .sidebar { width: 98vw; max-width: 99vw; padding-left: 3vw; padding-right: 3vw;}
    }
    #previewPDF {
      display: none; width: 210mm; height: 297mm;
      background: #fff; padding: 18mm 15mm 25mm 15mm; margin: 0 auto;
      font-size: 13px; line-height: 1.38; position: relative; overflow: hidden;
    }
    #previewPDF::before {
      content: ""; position: absolute; top: 48%; left: 50%;
      width: 140mm; height: 140mm;
      background: url('https://i.imgur.com/kf8e57F.jpg') no-repeat center center;
      background-size: contain; opacity: 0.06; transform: translate(-50%, -50%); z-index: 0;
    }
    #previewPDF > * { position: relative; z-index: 1;}
    #previewPDF .header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;
    }
    #previewPDF .header .logo-title {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    #previewPDF .header img {
      max-width: 195px; max-height: 135px; display: block; margin: 0 auto;
    }
    #previewPDF .header .title-groupar {
      font-size: 2.2em; font-weight: bold; letter-spacing: 1px; margin-top: 2px;
    }
    #previewPDF .header .title-groupar .azul { color: var(--azul);}
    #previewPDF .header .title-groupar .rojo { color: var(--rojo);}
    #previewPDF .header .datos { text-align: right; font-size: 1.07em;}
    #previewPDF table { width: 100%; border-collapse: collapse; margin-bottom: 10px;}
    #previewPDF th, #previewPDF td {
      padding: 8px; border: 1.5px solid #cde0f6; text-align: left; font-size: 13px;
    }
    #previewPDF th {
      background: var(--azul); color: #fff;
    }
    #previewPDF .summary {
      text-align: right; font-size: 13px; margin-bottom: 18px;
    }
    #previewPDF .footer {
      text-align: center; font-size: 11px; color: #888;
      border-top: 1px solid #ccc; padding-top: 8px;
      position: absolute; bottom: 15mm; left: 15mm; right: 15mm;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://i.imgur.com/kf8e57F.jpg" alt="Logo Grupo AR">
      <div class="logoTitle"><span>GRUPO</span> <span style="color:#dc1e28;">AR</span></div>
    </header>
    <div class="form-container">
      <div class="form-row">
        <div class="form-col">
          <label for="quoteTitle">Título de Cotización</label>
          <div class="input-wrap">
            <input id="quoteTitle" placeholder="Cotización #1234" value="Cotización probable – Nuevo cliente">
            <div class="btn-small-row">
              <button class="btn-micro" type="button" title="Dictar" data-target="quoteTitle">🎤</button>
              <button class="btn-correct" type="button" title="Corregir" data-target="quoteTitle">✓</button>
            </div>
          </div>
        </div>
        <div class="form-col">
          <label for="fileName">Nombre de Archivo</label>
          <div class="input-wrap">
            <input id="fileName" placeholder="cotizacion_1234" value="cotizacion_cliente" readonly>
            <div class="btn-small-row">
              <button class="btn-correct" type="button" data-target="fileName">✓</button>
            </div>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label for="quoteType">Tipo de Cotización</label>
          <select id="quoteType">
            <option value="express">Exprés</option>
            <option value="detailed">Detallada</option>
          </select>
        </div>
        <div class="form-col">
          <label for="client">Cliente</label>
          <div class="input-wrap">
            <input id="client" placeholder="Nombre del cliente">
            <div class="btn-small-row">
              <button class="btn-micro" type="button" title="Dictar" data-target="client">🎤</button>
              <button class="btn-correct" type="button" title="Corregir" data-target="client">✓</button>
            </div>
          </div>
        </div>
        <div class="form-col">
          <label for="location">Ubicación</label>
          <div class="input-wrap">
            <input id="location" placeholder="Dirección o ubicación">
            <div class="btn-small-row">
              <button class="btn-micro" type="button" title="Dictar" data-target="location">🎤</button>
              <button class="btn-correct" type="button" title="Corregir" data-target="location">✓</button>
            </div>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div>
          <input type="checkbox" id="withIvaSwitch" checked>
          <label for="withIvaSwitch" style="font-weight:400;">¿Incluir IVA (16%)?</label>
        </div>
        <div>
          <input type="checkbox" id="withAnticipoSwitch">
          <label for="withAnticipoSwitch" style="font-weight:400;">¿Incluir anticipo?</label>
        </div>
        <div id="anticipoField" style="display:none;max-width:160px;">
          <label for="anticipoPct">Anticipo (%)</label>
          <div class="input-wrap">
            <input id="anticipoPct" type="number" min="0" max="100" value="0">
            <div class="btn-small-row">
              <button class="btn-micro" type="button" title="Dictar" data-target="anticipoPct">🎤</button>
              <button class="btn-correct" type="button" title="Corregir" data-target="anticipoPct">✓</button>
            </div>
          </div>
        </div>
      </div>
      <h3 style="margin:16px 0 6px 0;">Agregar Item</h3>
      <div class="form-row" id="itemInputs">
        <div class="form-col" style="flex:2">
          <label for="newItemDesc">Descripción</label>
          <div class="input-wrap">
            <input id="newItemDesc" list="commonItemsList" placeholder="Ej. Pintura">
            <div class="btn-small-row">
              <button class="btn-micro" type="button" title="Dictar" data-target="newItemDesc">🎤</button>
              <button class="btn-correct" type="button" title="Corregir" data-target="newItemDesc">✓</button>
            </div>
          </div>
          <datalist id="commonItemsList"></datalist>
        </div>
        <div class="form-col" id="expressInputs" style="display:flex;">
          <div style="width:100%">
            <label for="newItemPrice">Precio</label>
            <div class="input-wrap">
              <input id="newItemPrice" type="number" min="0" value="0">
              <div class="btn-small-row">
                <button class="btn-micro" type="button" title="Dictar" data-target="newItemPrice">🎤</button>
                <button class="btn-correct" type="button" title="Corregir" data-target="newItemPrice">✓</button>
              </div>
            </div>
          </div>
        </div>
        <div class="form-col" id="detailedInputs" style="display:none;flex-direction:row;gap:6px;">
          <div>
            <label for="newItemQty">Cantidad</label>
            <div class="input-wrap">
              <input id="newItemQty" type="number" min="1" value="1">
              <div class="btn-small-row">
                <button class="btn-micro" type="button" title="Dictar" data-target="newItemQty">🎤</button>
                <button class="btn-correct" type="button" title="Corregir" data-target="newItemQty">✓</button>
              </div>
            </div>
          </div>
          <div>
            <label for="newItemMat">Material</label>
            <div class="input-wrap">
              <input id="newItemMat" type="number" min="0" value="0">
              <div class="btn-small-row">
                <button class="btn-micro" type="button" title="Dictar" data-target="newItemMat">🎤</button>
                <button class="btn-correct" type="button" title="Corregir" data-target="newItemMat">✓</button>
              </div>
            </div>
          </div>
          <div>
            <label for="newItemLab">Mano Obra</label>
            <div class="input-wrap">
              <input id="newItemLab" type="number" min="0" value="0">
              <div class="btn-small-row">
                <button class="btn-micro" type="button" title="Dictar" data-target="newItemLab">🎤</button>
                <button class="btn-correct" type="button" title="Corregir" data-target="newItemLab">✓</button>
              </div>
            </div>
          </div>
        </div>
        <div style="align-self:flex-end;min-width:108px;"><button id="addItemBtn">Agregar</button></div>
      </div>
      <div class="table-scroll">
        <table id="itemsTable">
          <thead>
            <tr id="header-express"><th>Descripción</th><th class="text-right">Precio</th><th class="text-right">Total</th><th></th></tr>
            <tr id="header-detailed" class="hidden">
              <th>Descripción</th><th class="text-right">Cant.</th><th class="text-right">Material</th><th class="text-right">Mano Obra</th><th class="text-right">Total</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="summary">
        <div>Subtotal: $<span id="subtotal">0.00</span></div>
        <div>IVA: $<span id="ivaAmount">0.00</span></div>
        <div><strong>Total: $<span id="totalAmount">0.00</span></strong></div>
        <div id="anticipoSummary" style="display:none;">Anticipo (<span id="anticipoPctDisplay">0</span>%): $<span id="anticipoAmount">0.00</span></div>
        <div><strong>Saldo: $<span id="balance">0.00</span></strong></div>
      </div>
      <button class="details-btn" id="openDetails">🛡️ Detalles y Especificaciones</button>
    </div>
    <div class="preview-container">
      <h3 style="font-size:1.08em;">Vista Previa (no es el PDF final)</h3>
      <div id="previewResponsive"></div>
      <div style="text-align:center; margin-top:12px;">
        <button id="generateBtn">Generar PDF</button>
        <button id="shareBtn">Compartir</button>
      </div>
    </div>
  </div>
  <!-- BACKDROP -->
  <div class="backdrop" id="backdrop"></div>
  <!-- SIDEBAR Detalles -->
  <div class="sidebar closed" id="detailsDrawer" tabindex="-1" aria-modal="true" aria-label="Detalles">
    <button class="sidebar-close" id="closeDetails" title="Cerrar">×</button>
    <h4>Detalles y Especificaciones</h4>
    <label><input type="checkbox" value="Pago 50% materiales antes de iniciar"> Pago 50% materiales antes de iniciar</label>
    <label><input type="checkbox" value="Pago 50% restante al finalizar"> Pago 50% restante al finalizar</label>
    <label><input type="checkbox" value="Incluye materiales, herramientas y mano de obra"> Incluye materiales, herramientas y mano de obra</label>
    <label><input type="checkbox" value="Retiro de escombro incluido"> Retiro de escombro incluido</label>
    <label><input type="checkbox" value="Limpieza general incluida"> Limpieza general incluida</label>
    <label><input type="checkbox" value="Garantía de funcionamiento"> Garantía de funcionamiento</label>
    <label><input type="checkbox" value="Garantía en materiales"> Garantía en materiales</label>
    <label><input type="checkbox" value="Vigencia cotización: 30 días"> Vigencia cotización: 30 días</label>
    <label><input type="checkbox" value="Responsabilidad por daños a terceros"> Responsabilidad terceros</label>
    <label><input type="checkbox" value="Cumplimiento normativas y permisos"> Cumplimiento normativas</label>
    <label><input type="checkbox" value="Cláusula de fuerza mayor"> Cláusula fuerza mayor</label>
    <div style="margin-top:13px; font-weight:600;">Detalles adicionales:</div>
    <div class="input-wrap">
      <textarea id="detalleAdicional" placeholder="Escribe o dicta un detalle y agrégalo abajo..."></textarea>
      <div class="btn-small-row">
        <button class="btn-micro" id="startVoice" title="Dictar">🎤</button>
        <button class="btn-correct" id="correctVoice" title="Corregir">✓</button>
      </div>
    </div>
    <button type="button" id="addDetalleBtn" style="background:#009e47; margin-bottom:9px;">Agregar detalle</button>
    <ul class="detalles-agregados" id="detallesAgregados"></ul>
    <span id="dictadoStatus" style="color:#0a6ec8;font-size:.98em;margin-top:3px;display:block;"></span>
  </div>
  <div id="previewPDF"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- Responsive Sidebar Drawer ---
    const openDetailsBtn = document.getElementById('openDetails');
    const closeDetailsBtn = document.getElementById('closeDetails');
    const detailsDrawer = document.getElementById('detailsDrawer');
    const backdrop = document.getElementById('backdrop');
    function openSidebar() {
      detailsDrawer.classList.remove('closed');
      detailsDrawer.classList.add('open');
      backdrop.classList.add('active');
      document.body.style.overflow = "hidden";
      setTimeout(()=>detailsDrawer.focus(), 280);
    }
    function closeSidebar() {
      detailsDrawer.classList.remove('open');
      detailsDrawer.classList.add('closed');
      backdrop.classList.remove('active');
      document.body.style.overflow = "";
    }
    openDetailsBtn.onclick = openSidebar;
    closeDetailsBtn.onclick = closeSidebar;
    backdrop.onclick = closeSidebar;
    document.addEventListener('keydown', e=>{
      if((detailsDrawer.classList.contains('open')) && e.key==='Escape') closeSidebar();
    });

    // Variables principales
    const quoteType = document.getElementById('quoteType');
    const tbody = document.querySelector('#itemsTable tbody');
    const hdrExp = document.getElementById('header-express');
    const hdrDet = document.getElementById('header-detailed');
    const anticipoPct = document.getElementById('anticipoPct');
    const anticipoPctDisp = document.getElementById('anticipoPctDisplay');
    const newItemDesc = document.getElementById('newItemDesc');
    const newItemQty = document.getElementById('newItemQty');
    const newItemMat = document.getElementById('newItemMat');
    const newItemLab = document.getElementById('newItemLab');
    const newItemPrice = document.getElementById('newItemPrice');
    const addItemBtn = document.getElementById('addItemBtn');
    const clientInput = document.getElementById('client');
    const locationInput = document.getElementById('location');
    const quoteTitle = document.getElementById('quoteTitle');
    const fileNameInput = document.getElementById('fileName');
    const commonItemsList = document.getElementById('commonItemsList');
    const previewRes = document.getElementById('previewResponsive');
    const previewPDF = document.getElementById('previewPDF');
    const withIvaSwitch = document.getElementById('withIvaSwitch');
    const withAnticipoSwitch = document.getElementById('withAnticipoSwitch');
    const anticipoField = document.getElementById('anticipoField');
    const anticipoSummary = document.getElementById('anticipoSummary');
    const expressInputs = document.getElementById('expressInputs');
    const detailedInputs = document.getElementById('detailedInputs');
    // Detalles adicionales dinámica
    const detalleAdicional = document.getElementById('detalleAdicional');
    const detallesAgregados = document.getElementById('detallesAgregados');
    let detallesArray = [];

    document.getElementById('addDetalleBtn').onclick = function() {
      let txt = detalleAdicional.value.trim();
      if (!txt) return;
      txt = autocorregir(txt);
      detallesArray.push(txt);
      detalleAdicional.value = "";
      renderDetalles();
    };
    function renderDetalles() {
      detallesAgregados.innerHTML = '';
      detallesArray.forEach((t,idx)=>{
        const li = document.createElement('li');
        li.textContent = t;
        const btn = document.createElement('button');
        btn.textContent = "✕";
        btn.className = "del-detalle";
        btn.onclick = ()=>{ detallesArray.splice(idx,1); renderDetalles(); };
        li.appendChild(btn);
        detallesAgregados.appendChild(li);
      });
    }

    // Autocorrección básica para todos los campos
    function autocorregir(text) {
      if (!text) return "";
      text = text.trim();
      if (text.length === 0) return "";
      text = text[0].toUpperCase() + text.slice(1);
      if(!/[.?!]$/.test(text)) text += ".";
      text = text.replace(/\s{2,}/g, ' ').replace(/ ,/g, ',');
      return text;
    }

    // Dictado para campos (todos)
    let recognition, recognizing = false;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'es-MX';
      recognition.continuous = false;
      recognition.interimResults = false;
      let currentTarget = null;
      let dictadoStatus = document.getElementById('dictadoStatus');
      function listenForField(targetElem) {
        currentTarget = targetElem;
        recognition.start();
        dictadoStatus.textContent="Escuchando...";
      }
      recognition.onresult = function(e) {
        let txt = e.results[0][0].transcript;
        txt = autocorregir(txt);
        if (currentTarget) {
          if (currentTarget.tagName==="INPUT"||currentTarget.tagName==="TEXTAREA") {
            currentTarget.value = txt;
            // Auto-refresca archivo si cambia el título
            if (currentTarget.id==="quoteTitle") syncTitleFileName();
          }
        }
        dictadoStatus.textContent="Texto agregado.";
        setTimeout(()=>dictadoStatus.textContent="",1200);
        currentTarget = null;
      };
      recognition.onerror = function(e) { dictadoStatus.textContent="Error de dictado: "+e.error; currentTarget = null; };
      recognition.onend = ()=>{ recognizing=false; };
      document.querySelectorAll('.btn-micro').forEach(btn=>{
        btn.onclick = function() {
          let field = document.getElementById(btn.dataset.target);
          if (!field) field = btn.parentElement.previousElementSibling;
          listenForField(field);
        }
      });
      document.getElementById('startVoice').onclick = function() {
        listenForField(detalleAdicional);
      }
    } else {
      document.querySelectorAll('.btn-micro').forEach(b=>b.style.display='none');
      document.getElementById('dictadoStatus').textContent="Dictado no disponible.";
    }

    // Corrección ortográfica y formal para todos los campos (simulado)
    document.querySelectorAll('.btn-correct').forEach(btn=>{
      btn.onclick = function() {
        let field = document.getElementById(btn.dataset.target);
        if (!field) field = btn.parentElement.previousElementSibling;
        if (field) {
          field.value = autocorregir(field.value);
          if (field.id==="quoteTitle") syncTitleFileName();
        }
      }
    });

    // Sincroniza automáticamente el nombre de archivo con el título de la cotización
    function syncTitleFileName() {
      let t = quoteTitle.value
        .toLowerCase()
        .replace(/[^\w\s-]/g,'') // quita caracteres no válidos
        .trim()
        .replace(/\s+/g,'_');
      fileNameInput.value = t || "cotizacion";
    }
    quoteTitle.addEventListener('input', syncTitleFileName);
    quoteTitle.addEventListener('blur', syncTitleFileName);
    document.addEventListener('DOMContentLoaded', syncTitleFileName);

    // Auto-corrección al salir de campo importante
    ['quoteTitle','client','location','detalleAdicional'].forEach(id=>{
      let field = document.getElementById(id);
      if(field) field.addEventListener('blur',()=>{ field.value = autocorregir(field.value); });
    });

    withIvaSwitch.onchange = recalc;
    withAnticipoSwitch.onchange = function(){
      anticipoField.style.display = this.checked ? "" : "none";
      anticipoSummary.style.display = this.checked ? "" : "none";
      recalc();
    };
    function updateTypeUI() {
      if (quoteType.value === "express") {
        expressInputs.style.display = "flex";
        detailedInputs.style.display = "none";
        hdrExp.classList.remove('hidden');
        hdrDet.classList.add('hidden');
      } else {
        expressInputs.style.display = "none";
        detailedInputs.style.display = "flex";
        hdrExp.classList.add('hidden');
        hdrDet.classList.remove('hidden');
      }
      recalc();
    }
    quoteType.onchange = updateTypeUI;
    updateTypeUI();

    const STORAGE_KEY = 'grupoAR_commonItems';
    let commonItems = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    function updateDatalist() {
      commonItemsList.innerHTML = '';
      Object.entries(commonItems)
        .sort((a,b)=>b[1]-a[1])
        .forEach(([desc])=>{
          const opt = document.createElement('option');
          opt.value = desc;
          commonItemsList.append(opt);
        });
    }
    function recordUsage(desc) {
      if (!desc) return;
      commonItems[desc] = (commonItems[desc]||0)+1;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(commonItems));
      updateDatalist();
    }
    updateDatalist();

    addItemBtn.onclick = ()=>{
      const desc = newItemDesc.value.trim(); if(!desc) return;
      const tr = document.createElement('tr');
      if(quoteType.value==='express'){
        const pr = parseFloat(newItemPrice.value)||0;
        tr.innerHTML = `<td><input class="desc" value="${desc}"></td>
          <td class="text-right"><input class="price" type="number" value="${pr}" min="0"></td>
          <td class="text-right"><span class="rowTotal">0.00</span></td>
          <td><button class="remove-btn">✕</button></td>`;
      } else {
        const qt = parseFloat(newItemQty.value)||1;
        const ma = parseFloat(newItemMat.value)||0;
        const lb = parseFloat(newItemLab.value)||0;
        tr.innerHTML = `<td><input class="desc" value="${desc}"></td>
          <td class="text-right"><input class="qty" type="number" value="${qt}" min="1"></td>
          <td class="text-right"><input class="mat" type="number" value="${ma}" min="0"></td>
          <td class="text-right"><input class="lab" type="number" value="${lb}" min="0"></td>
          <td class="text-right"><span class="rowTotal">0.00</span></td>
          <td><button class="remove-btn">✕</button></td>`;
      }
      tbody.appendChild(tr);
      tr.querySelectorAll('input').forEach(i=>i.oninput=recalc);
      tr.querySelector('.remove-btn').onclick = ()=>{ tr.remove(); recalc(); };
      recordUsage(desc);
      newItemDesc.value=''; recalc();
    };

    anticipoPct.oninput = recalc;

    function recalc(){
      let subtotal=0;
      tbody.querySelectorAll('tr').forEach(r=>{
        const qty=parseFloat(r.querySelector('.qty')?.value||1);
        const mat=parseFloat(r.querySelector('.mat')?.value||0);
        const lab=parseFloat(r.querySelector('.lab')?.value||0);
        const pr =parseFloat(r.querySelector('.price')?.value||0);
        const line = quoteType.value==='express'? pr : (mat+lab)*qty;
        r.querySelector('.rowTotal').textContent = line.toFixed(2);
        subtotal+=line;
      });
      document.getElementById('subtotal').textContent=subtotal.toFixed(2);
      const ivaAmt=withIvaSwitch.checked?subtotal*0.16:0;
      document.getElementById('ivaAmount').textContent=ivaAmt.toFixed(2);
      const total=subtotal+ivaAmt;
      document.getElementById('totalAmount').textContent=total.toFixed(2);
      if (withAnticipoSwitch.checked) {
        const pct=parseFloat(anticipoPct.value)||0;
        anticipoPctDisp.textContent=pct;
        const ant=total*pct/100;
        document.getElementById('anticipoAmount').textContent=ant.toFixed(2);
        document.getElementById('balance').textContent=(total-ant).toFixed(2);
      } else {
        anticipoPctDisp.textContent="0";
        document.getElementById('anticipoAmount').textContent="0.00";
        document.getElementById('balance').textContent=total.toFixed(2);
      }
      buildPreview(previewRes, false);
    }

    function buildPreview(container, isPDF){
      container.innerHTML = '';
      // Header: diferente para PDF vs Web
      if (isPDF) {
        const hdr = document.createElement('div');
        hdr.className = 'header';
        hdr.innerHTML = `
          <div class="logo-title">
            <img src="https://i.imgur.com/kf8e57F.jpg" crossorigin="anonymous">
            <div class="title-groupar"><span class="azul">GRUPO</span> <span class="rojo">AR</span></div>
          </div>
          <div class="datos">
            <div style="font-size:1.08em;"><b>${quoteTitle.value}</b></div>
            <div><strong>Cliente:</strong> ${clientInput.value||'--'}</div>
            <div><strong>Ubicación:</strong> ${locationInput.value||'--'}</div>
          </div>
        `;
        container.append(hdr);
      } else {
        const hdr = document.createElement('div');
        hdr.className = 'header';
        hdr.style.marginBottom = "10px";
        hdr.innerHTML = `
          <img src="https://i.imgur.com/kf8e57F.jpg" alt="Logo" style="height:30px;margin-right:8px;">
          <span style="font-weight:500;font-size:1.15em;color:#0a6ec8;">GRUPO <span style="color:#dc1e28">AR</span></span>
        `;
        container.append(hdr);
        const t = document.createElement('div');
        t.innerHTML = `<div style="font-size:1.09em"><b>${quoteTitle.value}</b></div>
        <div style="font-size:.97em"><strong>Cliente:</strong> ${clientInput.value||'--'}<br>
        <strong>Ubicación:</strong> ${locationInput.value||'--'}</div>`;
        t.style.marginBottom = "7px";
        container.append(t);
      }
      // Tabla
      const tbl=document.createElement('table');
      const head=quoteType.value==='express'
        ?`<tr><th>Descripción</th><th>Precio</th><th>Total</th></tr>`
        :`<tr><th>Descripción</th><th>Cant.</th><th>Material</th><th>Mano Obra</th><th>Total</th></tr>`;
      tbl.innerHTML=`<thead>${head}</thead><tbody></tbody>`;
      const body=tbl.querySelector('tbody');
      tbody.querySelectorAll('tr').forEach(r=>{
        const row=document.createElement('tr');
        Array.from(r.cells).slice(0,-1).forEach(c=>{
          const cl=c.cloneNode(true);
          const inp=cl.querySelector('input'), sp=cl.querySelector('span.rowTotal');
          if(inp) cl.textContent=inp.value;
          else if(sp) cl.textContent=sp.textContent;
          row.append(cl);
        });
        body.append(row);
      });
      container.append(tbl);

      // Summary
      const sum=document.createElement('div'); sum.className='summary';
      sum.innerHTML=`<div>Subtotal: $${document.getElementById('subtotal').textContent}</div>
        <div>IVA: $${document.getElementById('ivaAmount').textContent}</div>
        <div><strong>Total: $${document.getElementById('totalAmount').textContent}</strong></div>`;
      if (withAnticipoSwitch.checked) {
        sum.innerHTML += `<div>Anticipo (${anticipoPctDisp.textContent}%): $${document.getElementById('anticipoAmount').textContent}</div>`;
      }
      sum.innerHTML += `<div><strong>Saldo: $${document.getElementById('balance').textContent}</strong></div>`;
      container.append(sum);

      // Detalles
      const checks=Array.from(document.querySelectorAll('#detailsDrawer input:checked')).map(i=>i.value);
      if(checks.length || detallesArray.length){
        const dt=document.createElement('div');
        dt.innerHTML=`<h4 style="color:#0a6ec8">Detalles y Especificaciones</h4>
        <ul style="margin:4px 0 0 14px;">
        ${checks.map(t=>`<li>${t}</li>`).join('')}
        ${detallesArray.map(t=>`<li>${t}</li>`).join('')}
        </ul>`;
        container.append(dt);
      }

      // Footer solo en PDF
      if(isPDF) {
        const ft=document.createElement('div'); ft.className='footer';
        ft.textContent='GRUPO AR Construcción y Diseño — Tel: +52 1 438 134 6142';
        container.append(ft);
      }
    }

    async function generatePDF(){
      buildPreview(previewPDF, true);
      previewPDF.style.display='block';
      const canvas=await html2canvas(previewPDF,{scale:2,useCORS:true, backgroundColor:'#fff'});
      const img=canvas.toDataURL('image/png');
      const { jsPDF }=window.jspdf;
      const pdf=new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
      pdf.addImage(img,'PNG',0,0,210,297);
      previewPDF.style.display='none';
      return pdf;
    }

    document.getElementById('generateBtn').onclick=async()=>{
      const pdf=await generatePDF();
      const fn=(fileNameInput.value.trim()||'cotizacion')+'.pdf';
      pdf.save(fn);
    };
    document.getElementById('shareBtn').onclick=async()=>{
      try{
        const pdf=await generatePDF();
        const blob=pdf.output('blob');
        const file=new File([blob],(fileNameInput.value.trim()||'cotizacion')+'.pdf',{type:'application/pdf'});
        if(navigator.canShare&&navigator.canShare({files:[file]})){
          await navigator.share({files:[file],title:'Cotización Grupo AR'});
        } else {
          pdf.save(file.name);
          alert('PDF listo. Compártelo manualmente.');
        }
      }catch{ alert('Error al compartir.'); }
    };

    document.addEventListener('DOMContentLoaded', recalc);
  </script>
</body>
</html>
