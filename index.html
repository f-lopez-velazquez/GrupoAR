<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotizador Grupo AR</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --azul: #0a6ec8;
      --rojo: #dc1e28;
      --panel: #fff;
      --borde: #dde6f5;
      --txt: #222b3c;
      --fondo: #f7fafd;
      --gris: #a5b0c6;
    }
    body { font-family: 'Inter', Arial, sans-serif; background: var(--fondo); color: var(--txt); margin:0; }
    .container { max-width: 700px; margin:0 auto 26px auto; padding: 8px;}
    header { display:flex; align-items:center; gap:14px; justify-content:center; margin:22px 0 12px 0;}
    header img { height:56px; border-radius:12px; box-shadow: 0 2px 16px #b6d8fb68;}
    .logoTitle { font-size:1.65em; font-weight:700; color:var(--azul);}
    .logoTitle span { color: var(--rojo);}
    .form-container, .preview-container { background: var(--panel); border-radius: 14px; box-shadow: 0 2px 14px rgba(10,110,200,0.08); padding: 18px 10px 18px 10px; margin-bottom: 20px; }
    .form-row { display:flex; flex-wrap:wrap; gap:10px 13px; margin-bottom: 7px;}
    .form-col { flex:1 1 175px; min-width:130px;}
    label { font-weight: 600; color: var(--azul); display: block; font-size: 1.04em; margin-bottom: 1px; letter-spacing:.1px;}
    .input-wrap { position:relative; margin-bottom:2px;}
    input, select, textarea { width: 100%; box-sizing: border-box; border: 2px solid var(--borde); border-radius: 8px; font-size: 1em; padding: 10px 10px 10px 38px; background: #fafdff; color: var(--txt);}
    input:focus, textarea:focus, select:focus { border-color: var(--azul);}
    .input-icon { position:absolute; top:50%; left:10px; transform:translateY(-50%); font-size:1.13em; color: #93a5c6;}
    .mic-btn { position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:#13a0e5; font-size:1.18em; cursor:pointer; border-radius:5px; transition:background .12s;}
    .mic-btn.listening { color:#d9143b; background:#f7e6ea;}
    .btn-main, #generateBtn, #shareBtn { background: linear-gradient(90deg, var(--azul), var(--rojo) 92%); color: #fff; font-size: 1.09em; font-weight: 600; border: none; border-radius: 10px; letter-spacing: .15px; padding: 13px 0; cursor:pointer; width:100%; box-shadow: 0 2px 10px #b6cde948; transition: transform .1s; margin-top: 8px;}
    .btn-main:active, #generateBtn:active, #shareBtn:active { transform: scale(.97);}
    .switch-wrap { display: flex; align-items:center; gap:6px; margin-bottom:5px;}
    .switch { position: relative; display: inline-block; width: 48px; height: 27px; vertical-align: middle;}
    .switch input { opacity:0; width:0; height:0;}
    .slider { position: absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background: #d0dbef; border-radius:16px; transition:.18s;}
    .slider:before { position:absolute; content:""; left:4px; top:4px; width:19px; height:19px; background:#fff; border-radius:50%; transition:.17s; box-shadow: 0 1px 3px #b7b7b7;}
    input:checked + .slider { background: #4bb450;}
    input:checked + .slider:before { transform: translateX(20px);}
    .slide-label {font-size: .98em; font-weight: 500; color: var(--txt);}
    .form-row.switches { gap:18px;}
    .table-scroll { overflow-x:auto; border-radius:8px; }
    table { width:100%; border-collapse:collapse; margin-top:6px;}
    th, td { border:1.2px solid var(--borde); padding:10px 6px; font-size:.99em; background:transparent;}
    th { background:linear-gradient(90deg, #e8f2fb 75%, #f9e8ea 100%); color: var(--azul); font-weight: 600;}
    tr.row-highlight { background: #eaf7ee !important; animation:fadeRow .8s 1;}
    tr:nth-child(even) { background: #f7fcfa;}
    .btn-del { background:none; border:none; color:#c00; font-size:1.15em; cursor:pointer; transition: color .12s; padding:0 8px;}
    .btn-del:hover { color:#dc1e28;}
    .summary { margin-top:10px; text-align:right; font-size:1.03em; color: #384357;}
    .summary strong { font-size:1.14em;}
    .preview-container { margin-top:20px;}
    #previewResponsive { border:1.1px solid #d8e8f4; border-radius:8px; padding:12px; background: #f8fafc; font-size:1.06em; min-height:70px;}
    .ai-tools-bar { text-align:center; margin-bottom:8px;}
    .ai-tools-bar label { color:var(--azul); font-weight:600; font-size:1.03em;}
    .ai-toggle { margin:0 7px;}
    .historico-bar {margin:12px 0 10px 0; display:flex; flex-wrap:wrap; gap:8px;}
    .historico-bar button { font-size:.99em; padding:6px 10px; border-radius:7px; border:1.6px solid var(--azul); background:#e8f2fb; color:var(--azul); cursor:pointer;}
    .historico-bar button.active {background:#0a6ec8;color:#fff;}
    .historico-bar .delhist { color:#e00; margin-left:5px; background:transparent; border:none; cursor:pointer;}
    @media (max-width:700px){
      .container { max-width:99vw; padding:2vw;}
      .form-row { flex-direction:column; gap:4px;}
      .form-col { min-width:90px;}
      .form-container, .preview-container { padding:9px 2px 12px 2px;}
      table, th, td { font-size:.97em;}
      #previewResponsive { font-size:1em;}
      header img { height:44px;}
      .logoTitle { font-size:1.1em;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://i.imgur.com/kf8e57F.jpg" alt="Logo Grupo AR">
      <div class="logoTitle"><span>GRUPO</span> <span style="color:#dc1e28;">AR</span></div>
    </header>
    <div class="ai-tools-bar">
      <label>
        <input type="checkbox" class="ai-toggle" id="aiRedaccion" checked>
        üß† Mejora autom√°tica de redacci√≥n y ortograf√≠a
      </label>
      <label>
        <input type="checkbox" class="ai-toggle" id="aiPrediccion" checked>
        ‚ö° Autocompletar √≠tems frecuentes
      </label>
    </div>
    <div class="historico-bar" id="histContainer"></div>
    <!-- ...(sigue igual que la versi√≥n anterior, resto del formulario, tablas, switches, botones) -->
<!-- === SIDEBAR Detalles (oculto al iniciar) === -->
<div id="detailsDrawer" style="display:none;position:fixed;top:0;right:0;width:98vw;max-width:400px;min-width:220px;height:100%;background:#fff;box-shadow:-2px 0 20px #b4cde5cc;z-index:20;overflow-y:auto;padding:19px 18px 12px 18px;transition:right .23s;">
  <button id="closeDetails" title="Cerrar" style="position:absolute;top:12px;right:16px;font-size:1.8em;background:none;border:none;color:#e00;cursor:pointer;">√ó</button>
  <h4>Detalles y Especificaciones</h4>
  <div class="switch-wrap"><label class="slide-label" for="chk1">Pago 50% materiales antes de iniciar</label>
    <label class="switch"><input type="checkbox" id="chk1"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk2">Pago 50% restante al finalizar</label>
    <label class="switch"><input type="checkbox" id="chk2"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk3">Incluye materiales, herramientas y mano de obra</label>
    <label class="switch"><input type="checkbox" id="chk3"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk4">Retiro de escombro incluido</label>
    <label class="switch"><input type="checkbox" id="chk4"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk5">Limpieza general incluida</label>
    <label class="switch"><input type="checkbox" id="chk5"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk6">Garant√≠a de funcionamiento</label>
    <label class="switch"><input type="checkbox" id="chk6"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk7">Garant√≠a en materiales</label>
    <label class="switch"><input type="checkbox" id="chk7"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk8">Vigencia cotizaci√≥n: 30 d√≠as</label>
    <label class="switch"><input type="checkbox" id="chk8"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk9">Responsabilidad terceros</label>
    <label class="switch"><input type="checkbox" id="chk9"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk10">Cumplimiento normativas</label>
    <label class="switch"><input type="checkbox" id="chk10"><span class="slider"></span></label></div>
  <div class="switch-wrap"><label class="slide-label" for="chk11">Cl√°usula fuerza mayor</label>
    <label class="switch"><input type="checkbox" id="chk11"><span class="slider"></span></label></div>
  <label style="font-weight:500;margin-top:13px;">Detalles adicionales:</label>
  <textarea id="detalleAdicional" placeholder="Escribe un detalle adicional..."></textarea>
  <button type="button" id="addDetalleBtn" class="btn-main" style="background:#009e47; margin-bottom:9px;">Agregar detalle</button>
  <ul class="detalles-agregados" id="detallesAgregados"></ul>
</div>
<div id="dictadoStatus" style="display:none;position:fixed;z-index:500;top:0;left:0;width:100vw;text-align:center;font-size:1.14em;color:#fff;background:#119ec1b8;padding:10px 0 10px 0;"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let items = [], detallesArray = [];
let frequentDescs = JSON.parse(localStorage.getItem('ar_frequentDescs')||'[]');
let frequentPrices = JSON.parse(localStorage.getItem('ar_frequentPrices')||'{}');
let hist = JSON.parse(localStorage.getItem('ar_historial')||'[]');
const previewRes = document.getElementById('previewResponsive');

// --- UI: Oculta detalles al abrir la web ---
const detailsDrawer = document.getElementById('detailsDrawer');
detailsDrawer.style.right = '-440px';
detailsDrawer.style.display = "none";

// --- Detalles Sidebar ----
const openDetailsBtn = document.getElementById('openDetails');
const closeDetailsBtn = document.getElementById('closeDetails');
openDetailsBtn.onclick = function(){
  detailsDrawer.style.display = "block";
  setTimeout(()=>{detailsDrawer.style.right = "0";},50);
  document.body.style.overflow = "hidden";
};
closeDetailsBtn.onclick = function(){
  detailsDrawer.style.right = "-440px";
  setTimeout(()=>{detailsDrawer.style.display = "none";document.body.style.overflow="";},300);
};
document.addEventListener('keydown', e=>{if(detailsDrawer.style.right=="0px"&&e.key==='Escape') closeDetailsBtn.onclick();});

// --- Resto de c√≥digo en siguiente mensaje (parte final, s√≥lo JS: c√°lculos, IA, predicci√≥n, historial, PDF ultra PRO, compartir, dictado) ---
</script>
<script>
// ========== FUNCIONES AUXILIARES ==============
function toMoney(val) { return "$" + (+val).toFixed(2); }
function actualizarArchivo() {
  let t = document.getElementById('quoteTitle').value.toLowerCase().replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'_');
  document.getElementById('fileName').value = t || "cotizacion";
}
document.getElementById('quoteTitle').addEventListener('input', actualizarArchivo);
document.addEventListener('DOMContentLoaded', actualizarArchivo);

// ========== TIPO DE COTIZACION UI ==========
function updateTypeUI() {
  let quoteType = document.getElementById('quoteType');
  let expressInputs = document.getElementById('expressInputs');
  let detailedInputs = document.getElementById('detailedInputs');
  let theadExpress = document.getElementById('thead-express');
  let theadDetailed = document.getElementById('thead-detailed');
  if (quoteType.value === "express") {
    expressInputs.style.display = "flex";
    detailedInputs.style.display = "none";
    theadExpress.style.display = "";
    theadDetailed.style.display = "none";
  } else {
    expressInputs.style.display = "none";
    detailedInputs.style.display = "flex";
    theadExpress.style.display = "none";
    theadDetailed.style.display = "";
  }
  renderTable(); recalc();
}
document.getElementById('quoteType').onchange = updateTypeUI;

// ========== AGREGAR ITEMS ==========
document.getElementById('addItemBtn').onclick = ()=>{
  let desc = document.getElementById('newItemDesc').value.trim();
  if(!desc) return document.getElementById('newItemDesc').focus();
  if(document.getElementById('aiPrediccion').checked) {
    if(!frequentDescs.includes(desc)) {
      frequentDescs.push(desc);
      if(frequentDescs.length>35) frequentDescs=frequentDescs.slice(-35);
    }
  }
  if(document.getElementById('quoteType').value==='express'){
    let pr = parseFloat(document.getElementById('newItemPrice').value)||0;
    if(document.getElementById('aiPrediccion').checked) {
      frequentPrices[desc]=pr;
      localStorage.setItem('ar_frequentPrices',JSON.stringify(frequentPrices));
    }
    items.push({desc, pr});
  } else {
    let qt = parseFloat(document.getElementById('newItemQty').value)||1;
    let ma = parseFloat(document.getElementById('newItemMat').value)||0;
    let lb = parseFloat(document.getElementById('newItemLab').value)||0;
    items.push({desc, qt, ma, lb});
  }
  localStorage.setItem('ar_frequentDescs',JSON.stringify(frequentDescs));
  document.getElementById('newItemDesc').value='';
  document.getElementById('newItemPrice').value='0';
  document.getElementById('newItemQty').value='1';
  document.getElementById('newItemMat').value='0';
  document.getElementById('newItemLab').value='0';
  document.getElementById('newItemDesc').focus();
  updatePredictions();
  renderTable();
  recalc();
};

// ========== PREDICCI√ìN DESCRIPCIONES ==========
function updatePredictions() {
  if (!document.getElementById('aiPrediccion').checked) return;
  let dl = document.getElementById('descPredictions');
  dl.innerHTML = frequentDescs.slice(-15).reverse().map(desc=>`<option value="${desc}">`).join('');
}
document.getElementById('newItemDesc').addEventListener('input', function(){
  if (!document.getElementById('aiPrediccion').checked) return;
  let val = this.value.trim();
  let pr = frequentPrices[val];
  if(pr && document.getElementById('quoteType').value==='express') document.getElementById('newItemPrice').value = pr;
});

// ========== RENDER TABLA ==========
function renderTable(){
  const tbody = document.querySelector('#itemsTable tbody');
  tbody.innerHTML = '';
  let tipo = document.getElementById('quoteType').value;
  items.forEach((item, idx)=>{
    let tr = document.createElement('tr'); tr.className = 'row-highlight';
    setTimeout(()=>tr.classList.remove('row-highlight'),700);
    if(tipo==='express'){
      let pr = item.pr||0;
      let total = pr.toFixed(2);
      tr.innerHTML = `<td>${item.desc}</td>
        <td>${toMoney(pr)}</td>
        <td>${toMoney(total)}</td>
        <td><button class="btn-del" data-idx="${idx}">‚úï</button></td>`;
    } else {
      let qt = item.qt||1, ma = item.ma||0, lb = item.lb||0;
      let total = ((ma+lb)*qt).toFixed(2);
      tr.innerHTML = `<td>${item.desc}</td>
        <td>${qt}</td>
        <td>${toMoney(ma)}</td>
        <td>${toMoney(lb)}</td>
        <td>${toMoney(total)}</td>
        <td><button class="btn-del" data-idx="${idx}">‚úï</button></td>`;
    }
    tbody.appendChild(tr);
    tr.querySelector('.btn-del').onclick = ()=>{ items.splice(idx,1); renderTable(); recalc(); };
  });
  recalc();
}

// ========== RESUMEN Y C√ÅLCULOS ==========
function recalc(){
  let subtotal=0;
  if(document.getElementById('quoteType').value==="express"){
    items.forEach(item=>{subtotal+=item.pr||0;});
  } else {
    items.forEach(item=>{subtotal+=((item.ma||0)+(item.lb||0))*(item.qt||1);});
  }
  document.getElementById('subtotal').textContent=subtotal.toFixed(2);
  const ivaAmt=document.getElementById('withIvaSwitch').checked?subtotal*0.16:0;
  document.getElementById('ivaAmount').textContent=ivaAmt.toFixed(2);
  const total=subtotal+ivaAmt;
  document.getElementById('totalAmount').textContent=total.toFixed(2);
  const anticipo = document.getElementById('withAnticipoSwitch').checked ? parseFloat(document.getElementById('anticipoPct').value)||0 : 0;
  document.getElementById('anticipoSummary').style.display = anticipo ? "" : "none";
  document.getElementById('anticipoPctDisplay').textContent=anticipo;
  document.getElementById('anticipoAmount').textContent=(total*anticipo/100).toFixed(2);
  document.getElementById('balance').textContent=(total-total*anticipo/100).toFixed(2);
  buildPreview(previewRes, false);
}
document.getElementById('withIvaSwitch').onchange = recalc;
document.getElementById('withAnticipoSwitch').onchange = function(){
  document.getElementById('anticipoField').style.display = this.checked ? "" : "none";
  recalc();
};
document.getElementById('anticipoPct').oninput = recalc;

// ========== DETALLES Y ESPECIFICACIONES ==========
document.getElementById('addDetalleBtn').onclick = function() {
  let txt = document.getElementById('detalleAdicional').value.trim();
  if(!txt) return;
  detallesArray.push(txt);
  document.getElementById('detalleAdicional').value = "";
  renderDetalles();
};
function renderDetalles() {
  const detallesAgregados = document.getElementById('detallesAgregados');
  detallesAgregados.innerHTML = '';
  detallesArray.forEach((t,idx)=>{
    const li = document.createElement('li');
    li.textContent = t;
    const btn = document.createElement('button');
    btn.textContent = "‚úï";
    btn.className = "del-detalle";
    btn.onclick = ()=>{ detallesArray.splice(idx,1); renderDetalles(); };
    li.appendChild(btn);
    detallesAgregados.appendChild(li);
  });
}

// ========== VISTA PREVIA ==========
function buildPreview(container, isPDF){
  container.innerHTML = '';
  // Header
  const hdr = document.createElement('div');
  hdr.className = 'header';
  hdr.innerHTML = `<img src="https://i.imgur.com/kf8e57F.jpg" alt="Logo" style="height:${isPDF?'56':'36'}px;margin-right:10px;">
    <span style="font-weight:600;font-size:1.16em;color:#0a6ec8;">GRUPO <span style="color:#dc1e28">AR</span></span>`;
  container.append(hdr);
  const t = document.createElement('div');
  t.innerHTML = `<div style="font-size:1.09em"><b>${document.getElementById('quoteTitle').value}</b></div>
  <div style="font-size:.98em"><strong>Cliente:</strong> ${document.getElementById('client').value||'--'}<br>
  <strong>Ubicaci√≥n:</strong> ${document.getElementById('location').value||'--'}</div>`;
  t.style.marginBottom = "6px";
  container.append(t);
  // Tabla
  const tbl=document.createElement('table');
  let tipo=document.getElementById('quoteType').value;
  if(tipo==="express"){
    tbl.innerHTML=`<thead><tr><th>Descripci√≥n</th><th>Precio</th><th>Total</th></tr></thead><tbody></tbody>`;
    const body=tbl.querySelector('tbody');
    items.forEach(item=>{
      let tr = document.createElement('tr');
      let pr = item.pr||0, total = pr.toFixed(2);
      tr.innerHTML = `<td>${item.desc}</td><td>${toMoney(pr)}</td><td>${toMoney(total)}</td>`;
      body.appendChild(tr);
    });
  } else {
    tbl.innerHTML=`<thead><tr><th>Descripci√≥n</th><th>Cant.</th><th>Material</th><th>Mano Obra</th><th>Total</th></tr></thead><tbody></tbody>`;
    const body=tbl.querySelector('tbody');
    items.forEach(item=>{
      let qt = item.qt||1, ma = item.ma||0, lb = item.lb||0;
      let total = ((ma+lb)*qt).toFixed(2);
      let tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.desc}</td><td>${qt}</td><td>${toMoney(ma)}</td><td>${toMoney(lb)}</td><td>${toMoney(total)}</td>`;
      body.appendChild(tr);
    });
  }
  container.append(tbl);
  // Summary
  const sum=document.createElement('div'); sum.className='summary';
  sum.innerHTML=`<div>Subtotal: $${document.getElementById('subtotal').textContent}</div>
    <div>IVA: $${document.getElementById('ivaAmount').textContent}</div>
    <div><strong>Total: $${document.getElementById('totalAmount').textContent}</strong></div>`;
  const anticipo = document.getElementById('withAnticipoSwitch').checked ? parseFloat(document.getElementById('anticipoPct').value)||0 : 0;
  if (anticipo) {
    sum.innerHTML += `<div>Anticipo (${anticipo}%): $${document.getElementById('anticipoAmount').textContent}</div>`;
  }
  sum.innerHTML += `<div><strong>Saldo: $${document.getElementById('balance').textContent}</strong></div>`;
  container.append(sum);
  // Detalles y especificaciones
  let checks=[];
  for(let i=1;i<=11;i++){
    if(document.getElementById('chk'+i).checked) checks.push(document.querySelector('label[for=chk'+i+']').innerText);
  }
  if(checks.length || detallesArray.length){
    const dt=document.createElement('div');
    dt.innerHTML=`<h4 style="color:#0a6ec8">Detalles y Especificaciones</h4>
    <ul style="margin:4px 0 0 14px;">
    ${checks.map(t=>`<li>${t}</li>`).join('')}
    ${detallesArray.map(t=>`<li>${t}</li>`).join('')}
    </ul>`;
    container.append(dt);
  }
}
setInterval(()=>buildPreview(previewRes, false), 700);

// ========== HIST√ìRICO DE COTIZACIONES ==========
function guardarHistorial(){
  const datos = {
    title: document.getElementById('quoteTitle').value,
    client: document.getElementById('client').value,
    location: document.getElementById('location').value,
    type: document.getElementById('quoteType').value,
    items: JSON.parse(JSON.stringify(items)),
    detalles: JSON.parse(JSON.stringify(detallesArray)),
    chk: Array.from({length:11},(_,i)=>document.getElementById('chk'+(i+1)).checked),
    iva: document.getElementById('withIvaSwitch').checked,
    anticipo: document.getElementById('withAnticipoSwitch').checked,
    anticipoPct: document.getElementById('anticipoPct').value
  };
  let hist = JSON.parse(localStorage.getItem('ar_historial')||'[]');
  let idx = hist.findIndex(h=>h.title===datos.title);
  if(idx>=0) hist[idx]=datos;
  else hist.push(datos);
  localStorage.setItem('ar_historial',JSON.stringify(hist));
  mostrarHistorial();
  alert("Cotizaci√≥n guardada en historial.");
}
function mostrarHistorial(){
  let hist = JSON.parse(localStorage.getItem('ar_historial')||'[]');
  let cont = document.getElementById('histContainer');
  cont.innerHTML = hist.map((h,i)=>
    `<button onclick="cargarHistorial(${i})">${h.title||"Sin t√≠tulo"}</button>
     <button class="delhist" title="Eliminar" onclick="eliminarHistorial(${i})">üóëÔ∏è</button>`
  ).join("");
}
window.cargarHistorial = function(idx){
  let hist = JSON.parse(localStorage.getItem('ar_historial')||'[]');
  if(!hist[idx]) return;
  const h = hist[idx];
  document.getElementById('quoteTitle').value = h.title;
  document.getElementById('client').value = h.client;
  document.getElementById('location').value = h.location;
  document.getElementById('quoteType').value = h.type;
  items = JSON.parse(JSON.stringify(h.items));
  detallesArray = JSON.parse(JSON.stringify(h.detalles));
  for(let i=0;i<11;i++) document.getElementById('chk'+(i+1)).checked = !!h.chk[i];
  document.getElementById('withIvaSwitch').checked = h.iva;
  document.getElementById('withAnticipoSwitch').checked = h.anticipo;
  document.getElementById('anticipoPct').value = h.anticipoPct;
  updateTypeUI(); renderTable(); recalc(); renderDetalles();
}
window.eliminarHistorial = function(idx){
  let hist = JSON.parse(localStorage.getItem('ar_historial')||'[]');
  hist.splice(idx,1);
  localStorage.setItem('ar_historial',JSON.stringify(hist));
  mostrarHistorial();
}
document.getElementById('saveHistBtn').onclick = guardarHistorial;
mostrarHistorial();

// ========== DICTADO INDIVIDUAL EN CADA CAMPO ==========
let dictadoActivo = null;
let recognition;
function supportSpeech(){ return window.SpeechRecognition||window.webkitSpeechRecognition; }
function startDictado(target){
  if(!supportSpeech()) return;
  if(dictadoActivo) stopDictado();
  recognition = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  recognition.lang = "es-MX";
  recognition.interimResults = false;
  dictadoActivo = target;
  target.classList.add('listening');
  document.getElementById('dictadoStatus').textContent = "Escuchando‚Ä¶";
  document.getElementById('dictadoStatus').style.display = 'block';
  recognition.start();
  recognition.onresult = function(ev){
    let txt = ev.results[0][0].transcript;
    let inp = document.getElementById(target.getAttribute("data-for"));
    if(inp){
      inp.value = (inp.value ? inp.value + " " : "") + txt;
      inp.focus();
      if(inp.oninput) inp.oninput();
    }
    document.getElementById('dictadoStatus').textContent = "Dictado listo ‚úîÔ∏è";
    setTimeout(()=>document.getElementById('dictadoStatus').style.display='none', 1100);
  };
  recognition.onend = function(){ target.classList.remove('listening'); dictadoActivo=null; document.getElementById('dictadoStatus').style.display='none';};
  recognition.onerror = function(){ target.classList.remove('listening'); dictadoActivo=null; document.getElementById('dictadoStatus').textContent="Error en dictado";};
}
function stopDictado(){
  if(recognition){recognition.stop();}
  let btns = document.querySelectorAll('.mic-btn');
  btns.forEach(btn=>btn.classList.remove('listening'));
  dictadoActivo=null;
  document.getElementById('dictadoStatus').style.display='none';
}
document.querySelectorAll('.mic-btn').forEach(btn=>{
  btn.onclick = (e)=>{
    e.preventDefault();
    if(btn.classList.contains('listening')) { stopDictado(); return;}
    startDictado(btn);
  };
});

// ========== MEJORA AUTOM√ÅTICA (Redacci√≥n/Ortograf√≠a) ==========
async function mejorarRedaccion(){
  function corrigeFrase(txt){
    txt = txt.replace(/\s+/g," ").trim();
    if(txt.length===0) return "";
    txt = txt.charAt(0).toUpperCase() + txt.slice(1);
    if(!txt.endsWith(".")) txt += ".";
    return txt;
  }
  let t = document.getElementById('quoteTitle');
  t.value = corrigeFrase(t.value);
  let cl = document.getElementById('client');
  cl.value = corrigeFrase(cl.value);
  let loc = document.getElementById('location');
  loc.value = corrigeFrase(loc.value);
  items = items.map(it=>{
    if(document.getElementById('quoteType').value==='express'){
      return { desc: corrigeFrase(it.desc), pr: it.pr };
    } else {
      return { desc: corrigeFrase(it.desc), qt: it.qt, ma: it.ma, lb: it.lb };
    }
  });
  for(let i=0;i<detallesArray.length;i++){
    detallesArray[i] = corrigeFrase(detallesArray[i]);
  }
  renderTable();
  recalc();
  return Promise.resolve();
}

// ========== PDF PROFESIONAL, COMPARTIR ==========
async function generarPDFpro() {
  if(document.getElementById('aiRedaccion').checked) await mejorarRedaccion();
  let doc = new window.jspdf.jsPDF({unit:'mm', format:'a4'});
  // Marca de agua transl√∫cida y logo grande en encabezado
  let img = new Image();
  img.src = "https://i.imgur.com/kf8e57F.jpg";
  await new Promise(r=>{img.onload=r;});
  doc.addImage(img, 'JPEG', 28, 62, 150, 150, '', 'FAST', 0.11);
  // Logo principal
  doc.addImage(img, 'JPEG', 18, 10, 36, 36, '', 'FAST', 1);
  doc.setFont('helvetica','bold'); doc.setFontSize(23);
  doc.setTextColor(10,110,200);
  doc.text("GRUPO", 58, 24);
  doc.setTextColor(220,30,40);
  doc.text("AR", 92, 24);
  doc.setFontSize(13); doc.setTextColor(33,43,60);
  doc.text(document.getElementById('quoteTitle').value, 58, 31);
  doc.setFontSize(10);
  doc.text(`Cliente: ${document.getElementById('client').value||'--'}`,58,37);
  doc.text(`Ubicaci√≥n: ${document.getElementById('location').value||'--'}`,58,42);
  // Tabla (inicio bajo logo, margen izquierdo)
  let y = 54;
  let tipo = document.getElementById('quoteType').value;
  doc.setFontSize(11); doc.setTextColor(10,110,200);
  if(tipo==='express') {
    doc.text("Descripci√≥n",18,y); doc.text("Precio",93,y); doc.text("Total",140,y);
    y+=6; doc.setLineWidth(0.25); doc.line(18,y,195,y); doc.setTextColor(40,40,45); doc.setFontSize(10);
    items.forEach(it=>{
      doc.text(it.desc,18,y+6);
      doc.text(`$${(it.pr||0).toFixed(2)}`,93,y+6);
      doc.text(`$${(it.pr||0).toFixed(2)}`,140,y+6);
      y+=8.1;
    });
  } else {
    doc.text("Descripci√≥n",18,y); doc.text("Cant.",80,y); doc.text("Material",103,y); doc.text("Mano Obra",135,y); doc.text("Total",170,y);
    y+=6; doc.setLineWidth(0.25); doc.line(18,y,195,y); doc.setTextColor(40,40,45); doc.setFontSize(10);
    items.forEach(it=>{
      let tot = ((it.ma||0)+(it.lb||0))*(it.qt||1);
      doc.text(it.desc,18,y+6); doc.text(`${it.qt||1}`,80,y+6);
      doc.text(`$${(it.ma||0).toFixed(2)}`,103,y+6); doc.text(`$${(it.lb||0).toFixed(2)}`,135,y+6);
      doc.text(`$${tot.toFixed(2)}`,170,y+6);
      y+=8.1;
    });
  }
  y+=6;
  doc.setFontSize(11); doc.setTextColor(10,110,200);
  let subtotal=parseFloat(document.getElementById('subtotal').textContent)||0;
  let iva=parseFloat(document.getElementById('ivaAmount').textContent)||0;
  let total=parseFloat(document.getElementById('totalAmount').textContent)||0;
  let anticipo=parseFloat(document.getElementById('anticipoAmount').textContent)||0;
  let saldo=parseFloat(document.getElementById('balance').textContent)||0;
  doc.text(`Subtotal: $${subtotal.toFixed(2)}`,140,y);
  doc.text(`IVA: $${iva.toFixed(2)}`,140,y+6);
  doc.setFont('helvetica','bold');
  doc.text(`Total: $${total.toFixed(2)}`,140,y+12);
  if(anticipo>0){
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text(`Anticipo: $${anticipo.toFixed(2)}`,140,y+18);
    doc.text(`Saldo: $${saldo.toFixed(2)}`,140,y+24);
    y+=12;
  }
  y+=24;
  doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(10,110,200);
  doc.text("Detalles y Especificaciones:",18,y);
  doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(60,60,60);
  let y0 = y+4;
  let detalles = [];
  for(let i=1;i<=11;i++) if(document.getElementById('chk'+i).checked) detalles.push(document.querySelector('label[for=chk'+i+']').innerText);
  if(window.detallesArray && window.detallesArray.length) detalles = detalles.concat(window.detallesArray);
  detalles.forEach((d,idx)=>{
    doc.text(`‚Ä¢ ${d}`, 20, y0+6*idx);
  });
  y0 += 6*detalles.length;
  y0+=14;
  // Firma manuscrita
  doc.setDrawColor(10,110,200); doc.setLineWidth(0.7);
  doc.line(110, y0, 185, y0);
  doc.setFont('times','italic'); doc.setTextColor(10,110,200); doc.setFontSize(18);
  doc.text("Grupo AR", 112, y0+8);
  doc.setFontSize(9); doc.setTextColor(140,140,140); doc.setFont('helvetica','normal');
  doc.text("Firma simb√≥lica digital ‚Äî No requiere firma aut√≥grafa.",110, y0+15);
  // Footer
  doc.setFontSize(9); doc.setTextColor(150,150,150);
  doc.text("GRUPO AR Construcci√≥n y Dise√±o ‚Äî Tel: +52 1 438 134 6142",105,287,{align:'center'});
  let fname=(document.getElementById('fileName').value||'cotizacion')+'.pdf';
  // Guardar y/o compartir
  doc.save(fname);
  return {fname,doc};
}
document.getElementById('generateBtn').onclick = generarPDFpro;

// Compartir PRO usando Web Share API
document.getElementById('shareBtn').onclick = async ()=>{
  let {fname, doc} = await generarPDFpro();
  let blob = doc.output('blob');
  if (navigator.canShare && window.File && navigator.canShare({ files: [new File([blob], fname, {type: "application/pdf"})]})) {
    try {
      await navigator.share({
        files: [new File([blob], fname, {type: "application/pdf"})],
        title: fname,
        text: "Cotizaci√≥n GRUPO AR"
      });
    } catch(e) { alert("No se pudo compartir autom√°ticamente. Abre el PDF desde tu gestor de archivos para compartirlo."); }
  } else {
    alert("Comparte el PDF manualmente desde tu gestor de archivos. (Funci√≥n compartir autom√°tica no soportada en este navegador)");
  }
};

// Inicializar la app
updateTypeUI(); renderTable(); recalc(); renderDetalles();
</script>
