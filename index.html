<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Generador de Cotizaciones ‚Äì Grupo AR</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: 'Helvetica', Arial, sans-serif;
      background: #f7f9fa;
      color: #222;
      min-height: 100vh;
      overscroll-behavior: none;
    }
    .container {
      max-width: 700px;
      margin: 0 auto 30px auto;
      padding: 8px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0 16px 0;
      justify-content: center;
    }
    header img { height: 38px; }
    header .logoTitle {
      font-size: 1.3em;
      font-weight: bold;
      letter-spacing: 0.5px;
      color: #0a6ec8;
      line-height: 1;
    }
    header .logoTitle span { color: #dc1e28; }
    .form-container, .preview-container {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 14px 10px 18px 10px;
      margin-bottom: 20px;
    }
    .form-container label { margin-bottom: 3px; display:block; font-weight:500;}
    .flex { display: flex; gap: 14px; flex-wrap: wrap; }
    .flex > * { flex: 1 1 150px; min-width: 120px; }
    .input-group {
      display: flex; align-items: center; gap: 6px;
      margin-bottom: 12px;
    }
    .input-group input, .input-group textarea {
      flex: 1 1 auto;
      margin-bottom: 0;
    }
    .input-group .dictate-btn, .input-group .correct-btn {
      background: #e3f1fb;
      border: none;
      border-radius: 4px;
      padding: 7px 10px 7px 8px;
      cursor: pointer;
      font-size: 1.1em;
      color: #0a6ec8;
      margin-left: 2px;
      margin-bottom: 0;
      transition: background 0.12s;
    }
    .input-group .correct-btn {
      color: #009e47;
      background: #e3fae7;
    }
    .input-group .dictate-btn:active { background: #b4e1f9; }
    .input-group .correct-btn:active { background: #c4ffd2; }
    input, select, textarea, button {
      width: 100%;
      padding: 8px 7px;
      margin-bottom: 12px;
      border: 1px solid #d4dbe4;
      border-radius: 6px;
      font-size: 1em;
      background: #fafbfc;
      box-sizing: border-box;
    }
    textarea { resize: vertical; min-height: 38px; }
    button { background: #0a6ec8; color: #fff; border: none; cursor: pointer; font-weight: bold;}
    button:active { background: #095bb1; }
    .switch {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 1em;
    }
    .switch input[type=checkbox] {
      accent-color: #0a6ec8;
      width: 1.1em; height: 1.1em; margin: 0;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 8px 7px; border: 1px solid #eaeaea; font-size: 1em; }
    th { background: #f0f5fb; color: #0a6ec8; font-size: 1em;}
    .remove-btn { background: none; border: none; color: #c00; font-size: 1.2em; cursor: pointer; }
    .summary { margin-top: 16px; text-align: right; font-size: 1.05em; }
    .summary div { margin-bottom: 5px; }
    .table-scroll { overflow-x: auto; }
    #previewResponsive {
      min-height: 160px; border: 1px solid #e6e6e6;
      border-radius: 7px; padding: 12px; background: #f9fbfe;
      margin-bottom: 12px;
    }
    .details-btn {
      display: block;
      width: 100%;
      padding: 14px 0;
      background: #0a6ec8;
      color: #fff;
      border: none;
      border-radius: 0 0 7px 7px;
      font-size: 1.08em;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.15s;
      margin-top: 0;
      margin-bottom: 0;
      letter-spacing: 0.5px;
    }
    .details-btn:active { background: #095bb1; }
    /* BACKDROP */
    .backdrop {
      display: none;
      position: fixed;
      top:0; left:0; width:100vw; height:100vh;
      background: rgba(16,32,56,0.29);
      z-index: 998;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .backdrop.active {
      display: block;
      opacity: 1;
    }
    /* SIDEBAR detalles */
    .sidebar {
      position: fixed;
      top: 0;
      right: -330px;
      width: 310px;
      max-width: 94vw;
      height: 100vh;
      background: #fff;
      box-shadow: -2px 0 16px rgba(0,0,0,0.16);
      z-index: 999;
      transition: right 0.4s cubic-bezier(.44,0,.2,1);
      padding: 24px 18px 18px 14px;
      overflow-y: auto;
      border-radius: 12px 0 0 12px;
      display: flex;
      flex-direction: column;
      min-width: 170px;
      pointer-events: auto;
    }
    .sidebar.closed {
      right: -340px !important;
      pointer-events: none;
    }
    .sidebar.open { right: 0 !important; pointer-events:auto; }
    .sidebar h4 { color: #0a6ec8; margin-bottom: 12px;}
    .sidebar label {
      display: flex; align-items: center; gap: 8px;
      font-weight: 400;
      margin-bottom: 10px;
      cursor: pointer;
      font-size: 1em;
    }
    .sidebar textarea {
      margin-top: 7px;
      min-height: 44px;
      background: #f3f6fa;
      border: 1px solid #c3dbfc;
      font-size: 1em;
      margin-bottom: 6px;
      border-radius: 6px;
    }
    .sidebar-close {
      background: none; border: none; color: #0a6ec8; font-size: 1.6em; position: absolute; top: 8px; right: 12px; cursor: pointer;
    }
    .detalles-agregados {
      margin: 10px 0 0 0; padding: 0;
      list-style: disc;
      color: #234; font-size: 1em;
    }
    .detalles-agregados li {
      margin: 3px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 7px;
      background: #f8fcff;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .detalles-agregados .del-detalle {
      color: #c00; background:none; border:none; font-size:1.2em; cursor:pointer;
      margin-left: 9px;
    }
    @media (max-width: 760px) {
      .container { max-width: 100vw; padding: 1vw; }
      .flex { gap: 5px; }
      .flex > * { min-width: 85px; }
      .sidebar { width: 99vw; min-width: 110px; padding-left: 5vw; padding-right: 5vw;}
      .sidebar label { font-size: 1.06em; }
      .sidebar textarea { font-size: 1em; }
    }
    @media (max-width: 500px) {
      header .logoTitle { font-size: 1.02em; }
      .sidebar { padding: 13px 3vw 10px 4vw; }
    }
    #previewPDF {
      display: none;
      width: 210mm; height: 297mm;
      background: #fff; padding: 18mm 15mm 25mm 15mm;
      margin: 0 auto;
      font-size: 13px; line-height: 1.38;
      position: relative;
      overflow: hidden;
    }
    #previewPDF::before {
      content: "";
      position: absolute;
      top: 48%; left: 50%;
      width: 140mm; height: 140mm;
      background: url('https://i.imgur.com/kf8e57F.jpg') no-repeat center center;
      background-size: contain;
      opacity: 0.06;
      transform: translate(-50%, -50%);
      z-index: 0;
    }
    #previewPDF > * { position: relative; z-index: 1; }
    #previewPDF .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 18px;
    }
    #previewPDF .header .logo-title {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
    }
    #previewPDF .header img {
      max-width: 195px; max-height: 135px;
      display: block; margin: 0 auto;
    }
    #previewPDF .header .title-groupar {
      font-size: 2.2em;
      font-weight: bold;
      letter-spacing: 1px;
      margin-top: 2px;
    }
    #previewPDF .header .title-groupar .azul { color: #0a6ec8; }
    #previewPDF .header .title-groupar .rojo { color: #dc1e28; }
    #previewPDF .header .datos {
      text-align: right; font-size: 1.07em;
    }
    #previewPDF table {
      width: 100%; border-collapse: collapse; margin-bottom: 10px;
    }
    #previewPDF th, #previewPDF td {
      padding: 8px; border: 1px solid #ddd; text-align: left; font-size: 13px;
    }
    #previewPDF th {
      background: #0a6ec8; color: #fff;
    }
    #previewPDF .summary {
      text-align: right; font-size: 13px; margin-bottom: 18px;
    }
    #previewPDF .footer {
      text-align: center; font-size: 11px; color: #888;
      border-top: 1px solid #ccc; padding-top: 8px;
      position: absolute; bottom: 15mm; left: 15mm; right: 15mm;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://i.imgur.com/kf8e57F.jpg" alt="Logo Grupo AR">
      <div class="logoTitle"><span>GRUPO</span> <span style="color:#dc1e28;">AR</span></div>
    </header>
    <div class="form-container">
      <div class="flex">
        <div>
          <label for="quoteTitle">T√≠tulo de Cotizaci√≥n</label>
          <div class="input-group">
            <input id="quoteTitle" placeholder="Cotizaci√≥n #1234" value="Cotizaci√≥n probable ‚Äì Nuevo cliente">
            <button class="dictate-btn" title="Dictar" data-target="quoteTitle">üé§</button>
            <button class="correct-btn" title="Corregir" data-target="quoteTitle">‚úì</button>
          </div>
        </div>
        <div>
          <label for="fileName">Nombre de Archivo</label>
          <div class="input-group">
            <input id="fileName" placeholder="cotizacion_1234" value="cotizacion_cliente">
            <button class="dictate-btn" title="Dictar" data-target="fileName">üé§</button>
            <button class="correct-btn" title="Corregir" data-target="fileName">‚úì</button>
          </div>
        </div>
      </div>
      <div class="flex">
        <div>
          <label for="quoteType">Tipo de Cotizaci√≥n</label>
          <select id="quoteType">
            <option value="express">Expr√©s</option>
            <option value="detailed">Detallada</option>
          </select>
        </div>
        <div>
          <label for="client">Cliente</label>
          <div class="input-group">
            <input id="client" placeholder="Nombre del cliente">
            <button class="dictate-btn" title="Dictar" data-target="client">üé§</button>
            <button class="correct-btn" title="Corregir" data-target="client">‚úì</button>
          </div>
        </div>
        <div>
          <label for="location">Ubicaci√≥n</label>
          <div class="input-group">
            <input id="location" placeholder="Direcci√≥n o ubicaci√≥n">
            <button class="dictate-btn" title="Dictar" data-target="location">üé§</button>
            <button class="correct-btn" title="Corregir" data-target="location">‚úì</button>
          </div>
        </div>
      </div>
      <div class="flex">
        <div class="switch"><input type="checkbox" id="withIvaSwitch" checked><label for="withIvaSwitch" style="font-weight:400;">¬øIncluir IVA (16%)?</label></div>
        <div class="switch"><input type="checkbox" id="withAnticipoSwitch"><label for="withAnticipoSwitch" style="font-weight:400;">¬øIncluir anticipo?</label></div>
        <div id="anticipoField" style="display:none">
          <label for="anticipoPct">Anticipo (%)</label>
          <div class="input-group">
            <input id="anticipoPct" type="number" min="0" max="100" value="0">
            <button class="dictate-btn" title="Dictar" data-target="anticipoPct">üé§</button>
            <button class="correct-btn" title="Corregir" data-target="anticipoPct">‚úì</button>
          </div>
        </div>
      </div>
      <h3 style="font-size:1.15em;margin:10px 0 6px 0;">Agregar Item</h3>
      <div class="flex" id="itemInputs">
        <div style="flex:2">
          <label for="newItemDesc">Descripci√≥n</label>
          <div class="input-group">
            <input id="newItemDesc" list="commonItemsList" placeholder="Ej. Pintura">
            <button class="dictate-btn" title="Dictar" data-target="newItemDesc">üé§</button>
            <button class="correct-btn" title="Corregir" data-target="newItemDesc">‚úì</button>
          </div>
          <datalist id="commonItemsList"></datalist>
        </div>
        <div id="expressInputs" style="display:flex;gap:10px;">
          <div style="flex:1">
            <label for="newItemPrice">Precio</label>
            <div class="input-group">
              <input id="newItemPrice" type="number" min="0" value="0">
              <button class="dictate-btn" title="Dictar" data-target="newItemPrice">üé§</button>
              <button class="correct-btn" title="Corregir" data-target="newItemPrice">‚úì</button>
            </div>
          </div>
        </div>
        <div id="detailedInputs" style="display:none;gap:10px;">
          <div><label for="newItemQty">Cantidad</label>
            <div class="input-group">
              <input id="newItemQty" type="number" min="1" value="1">
              <button class="dictate-btn" title="Dictar" data-target="newItemQty">üé§</button>
              <button class="correct-btn" title="Corregir" data-target="newItemQty">‚úì</button>
            </div>
          </div>
          <div><label for="newItemMat">Material</label>
            <div class="input-group">
              <input id="newItemMat" type="number" min="0" value="0">
              <button class="dictate-btn" title="Dictar" data-target="newItemMat">üé§</button>
              <button class="correct-btn" title="Corregir" data-target="newItemMat">‚úì</button>
            </div>
          </div>
          <div><label for="newItemLab">Mano Obra</label>
            <div class="input-group">
              <input id="newItemLab" type="number" min="0" value="0">
              <button class="dictate-btn" title="Dictar" data-target="newItemLab">üé§</button>
              <button class="correct-btn" title="Corregir" data-target="newItemLab">‚úì</button>
            </div>
          </div>
        </div>
        <div style="align-self:flex-end;"><button id="addItemBtn">Agregar</button></div>
      </div>
      <div class="table-scroll">
        <table id="itemsTable">
          <thead>
            <tr id="header-express"><th>Descripci√≥n</th><th class="text-right">Precio</th><th class="text-right">Total</th><th></th></tr>
            <tr id="header-detailed" class="hidden">
              <th>Descripci√≥n</th><th class="text-right">Cant.</th><th class="text-right">Material</th><th class="text-right">Mano Obra</th><th class="text-right">Total</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="summary">
        <div>Subtotal: $<span id="subtotal">0.00</span></div>
        <div>IVA: $<span id="ivaAmount">0.00</span></div>
        <div><strong>Total: $<span id="totalAmount">0.00</span></strong></div>
        <div id="anticipoSummary" style="display:none;">Anticipo (<span id="anticipoPctDisplay">0</span>%): $<span id="anticipoAmount">0.00</span></div>
        <div><strong>Saldo: $<span id="balance">0.00</span></strong></div>
      </div>
      <button class="details-btn" id="openDetails">üõ°Ô∏è Detalles y Especificaciones</button>
    </div>
    <div class="preview-container">
      <h3 style="font-size:1.08em;">Vista Previa (no es el PDF final)</h3>
      <div id="previewResponsive"></div>
      <div style="text-align:center; margin-top:12px;">
        <button id="generateBtn">Generar PDF</button>
        <button id="shareBtn">Compartir</button>
      </div>
    </div>
  </div>
  <!-- BACKDROP -->
  <div class="backdrop" id="backdrop"></div>
  <!-- SIDEBAR Detalles -->
  <div class="sidebar closed" id="detailsDrawer" tabindex="-1" aria-modal="true" aria-label="Detalles">
    <button class="sidebar-close" id="closeDetails" title="Cerrar">√ó</button>
    <h4>Detalles y Especificaciones</h4>
    <label><input type="checkbox" value="Pago 50% materiales antes de iniciar"> Pago 50% materiales antes de iniciar</label>
    <label><input type="checkbox" value="Pago 50% restante al finalizar"> Pago 50% restante al finalizar</label>
    <label><input type="checkbox" value="Incluye materiales, herramientas y mano de obra"> Incluye materiales, herramientas y mano de obra</label>
    <label><input type="checkbox" value="Retiro de escombro incluido"> Retiro de escombro incluido</label>
    <label><input type="checkbox" value="Limpieza general incluida"> Limpieza general incluida</label>
    <label><input type="checkbox" value="Garant√≠a de funcionamiento"> Garant√≠a de funcionamiento</label>
    <label><input type="checkbox" value="Garant√≠a en materiales"> Garant√≠a en materiales</label>
    <label><input type="checkbox" value="Vigencia cotizaci√≥n: 30 d√≠as"> Vigencia cotizaci√≥n: 30 d√≠as</label>
    <label><input type="checkbox" value="Responsabilidad por da√±os a terceros"> Responsabilidad terceros</label>
    <label><input type="checkbox" value="Cumplimiento normativas y permisos"> Cumplimiento normativas</label>
    <label><input type="checkbox" value="Cl√°usula de fuerza mayor"> Cl√°usula fuerza mayor</label>
    <div style="margin-top:13px; font-weight:600;">Detalles adicionales:</div>
    <div class="input-group">
      <textarea id="detalleAdicional" placeholder="Escribe o dicta un detalle y agr√©galo abajo..."></textarea>
      <button class="dictate-btn" id="startVoice" title="Dictar">üé§</button>
      <button class="correct-btn" id="correctVoice" title="Corregir">‚úì</button>
    </div>
    <button type="button" id="addDetalleBtn" style="background:#009e47; margin-bottom:9px;">Agregar detalle</button>
    <ul class="detalles-agregados" id="detallesAgregados"></ul>
    <span id="dictadoStatus" style="color:#0a6ec8;font-size:.98em;margin-top:3px;display:block;"></span>
  </div>
  <div id="previewPDF"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- Responsive Sidebar Drawer ---
    const openDetailsBtn = document.getElementById('openDetails');
    const closeDetailsBtn = document.getElementById('closeDetails');
    const detailsDrawer = document.getElementById('detailsDrawer');
    const backdrop = document.getElementById('backdrop');
    function openSidebar() {
      detailsDrawer.classList.remove('closed');
      detailsDrawer.classList.add('open');
      backdrop.classList.add('active');
      document.body.style.overflow = "hidden";
      setTimeout(()=>detailsDrawer.focus(), 280);
    }
    function closeSidebar() {
      detailsDrawer.classList.remove('open');
      detailsDrawer.classList.add('closed');
      backdrop.classList.remove('active');
      document.body.style.overflow = "";
    }
    openDetailsBtn.onclick = openSidebar;
    closeDetailsBtn.onclick = closeSidebar;
    backdrop.onclick = closeSidebar;
    document.addEventListener('keydown', e=>{
      if((detailsDrawer.classList.contains('open')) && e.key==='Escape') closeSidebar();
    });

    // Resto del c√≥digo igual que antes...
    const quoteType = document.getElementById('quoteType');
    const tbody = document.querySelector('#itemsTable tbody');
    const hdrExp = document.getElementById('header-express');
    const hdrDet = document.getElementById('header-detailed');
    const anticipoPct = document.getElementById('anticipoPct');
    const anticipoPctDisp = document.getElementById('anticipoPctDisplay');
    const newItemDesc = document.getElementById('newItemDesc');
    const newItemQty = document.getElementById('newItemQty');
    const newItemMat = document.getElementById('newItemMat');
    const newItemLab = document.getElementById('newItemLab');
    const newItemPrice = document.getElementById('newItemPrice');
    const addItemBtn = document.getElementById('addItemBtn');
    const clientInput = document.getElementById('client');
    const locationInput = document.getElementById('location');
    const quoteTitle = document.getElementById('quoteTitle');
    const fileNameInput = document.getElementById('fileName');
    const commonItemsList = document.getElementById('commonItemsList');
    const previewRes = document.getElementById('previewResponsive');
    const previewPDF = document.getElementById('previewPDF');
    const withIvaSwitch = document.getElementById('withIvaSwitch');
    const withAnticipoSwitch = document.getElementById('withAnticipoSwitch');
    const anticipoField = document.getElementById('anticipoField');
    const anticipoSummary = document.getElementById('anticipoSummary');
    const expressInputs = document.getElementById('expressInputs');
    const detailedInputs = document.getElementById('detailedInputs');
    // Detalles adicionales din√°mica
    const detalleAdicional = document.getElementById('detalleAdicional');
    const detallesAgregados = document.getElementById('detallesAgregados');
    let detallesArray = [];

    document.getElementById('addDetalleBtn').onclick = function() {
      let txt = detalleAdicional.value.trim();
      if (!txt) return;
      txt = autocorregir(txt);
      detallesArray.push(txt);
      detalleAdicional.value = "";
      renderDetalles();
    };
    function renderDetalles() {
      detallesAgregados.innerHTML = '';
      detallesArray.forEach((t,idx)=>{
        const li = document.createElement('li');
        li.textContent = t;
        const btn = document.createElement('button');
        btn.textContent = "‚úï";
        btn.className = "del-detalle";
        btn.onclick = ()=>{ detallesArray.splice(idx,1); renderDetalles(); };
        li.appendChild(btn);
        detallesAgregados.appendChild(li);
      });
    }

    // Autocorrecci√≥n b√°sica para todos los campos (simulaci√≥n, puede mejorarse con IA real si deseas backend o GPT API)
    function autocorregir(text) {
      if (!text) return "";
      // May√∫scula al inicio, min√∫sculas a lo dem√°s, punto final.
      text = text.trim();
      if (text.length === 0) return "";
      text = text[0].toUpperCase() + text.slice(1);
      if(!/[.?!]$/.test(text)) text += ".";
      // Simula correcci√≥n ortogr√°fica m√≠nima:
      text = text.replace(/\s{2,}/g, ' ').replace(/ ,/g, ',');
      // (aqu√≠ puedes a√±adir reglas de ortograf√≠a y estilo adicionales o enviar a una API de correcci√≥n si lo deseas)
      return text;
    }

    // Dictado para campos (todos)
    let recognition, recognizing = false;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'es-MX';
      recognition.continuous = false;
      recognition.interimResults = false;
      let currentTarget = null;
      let dictadoStatus = document.getElementById('dictadoStatus');
      function listenForField(targetElem) {
        currentTarget = targetElem;
        recognition.start();
        dictadoStatus.textContent="Escuchando...";
      }
      recognition.onresult = function(e) {
        let txt = e.results[0][0].transcript;
        txt = autocorregir(txt);
        if (currentTarget) {
          if (currentTarget.tagName==="INPUT"||currentTarget.tagName==="TEXTAREA") {
            currentTarget.value = (currentTarget.value ? currentTarget.value + " " : "") + txt;
          }
        }
        dictadoStatus.textContent="Texto agregado.";
        setTimeout(()=>dictadoStatus.textContent="",1200);
        currentTarget = null;
      };
      recognition.onerror = function(e) { dictadoStatus.textContent="Error de dictado: "+e.error; currentTarget = null; };
      recognition.onend = ()=>{ recognizing=false; };
      // Asocia todos los botones .dictate-btn
      document.querySelectorAll('.dictate-btn').forEach(btn=>{
        btn.onclick = function() {
          let field = document.getElementById(btn.dataset.target);
          if (!field) field = btn.previousElementSibling || btn.parentElement.querySelector('input,textarea');
          listenForField(field);
        }
      });
      document.getElementById('startVoice').onclick = function() {
        listenForField(detalleAdicional);
      }
    } else {
      // Si no hay dictado
      document.querySelectorAll('.dictate-btn').forEach(b=>b.style.display='none');
      document.getElementById('dictadoStatus').textContent="Dictado no disponible.";
    }

    // Correcci√≥n ortogr√°fica y formal para todos los campos (simulado)
    document.querySelectorAll('.correct-btn').forEach(btn=>{
      btn.onclick = function() {
        let field = document.getElementById(btn.dataset.target);
        if (!field) field = btn.previousElementSibling || btn.parentElement.querySelector('input,textarea');
        if (field) field.value = autocorregir(field.value);
      }
    });

    // Auto-correcci√≥n al salir de campo importante
    ['quoteTitle','client','location','detalleAdicional'].forEach(id=>{
      let field = document.getElementById(id);
      if(field) field.addEventListener('blur',()=>{ field.value = autocorregir(field.value); });
    });

    // Resto: predictivo, items frecuentes, c√°lculos, vista previa, PDF igual que antes...
    withIvaSwitch.onchange = recalc;
    withAnticipoSwitch.onchange = function(){
      anticipoField.style.display = this.checked ? "" : "none";
      anticipoSummary.style.display = this.checked ? "" : "none";
      recalc();
    };
    function updateTypeUI() {
      if (quoteType.value === "express") {
        expressInputs.style.display = "flex";
        detailedInputs.style.display = "none";
        hdrExp.classList.remove('hidden');
        hdrDet.classList.add('hidden');
      } else {
        expressInputs.style.display = "none";
        detailedInputs.style.display = "flex";
        hdrExp.classList.add('hidden');
        hdrDet.classList.remove('hidden');
      }
      recalc();
    }
    quoteType.onchange = updateTypeUI;
    updateTypeUI();

    const STORAGE_KEY = 'grupoAR_commonItems';
    let commonItems = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    function updateDatalist() {
      commonItemsList.innerHTML = '';
      Object.entries(commonItems)
        .sort((a,b)=>b[1]-a[1])
        .forEach(([desc])=>{
          const opt = document.createElement('option');
          opt.value = desc;
          commonItemsList.append(opt);
        });
    }
    function recordUsage(desc) {
      if (!desc) return;
      commonItems[desc] = (commonItems[desc]||0)+1;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(commonItems));
      updateDatalist();
    }
    updateDatalist();

    addItemBtn.onclick = ()=>{
      const desc = newItemDesc.value.trim(); if(!desc) return;
      const tr = document.createElement('tr');
      if(quoteType.value==='express'){
        const pr = parseFloat(newItemPrice.value)||0;
        tr.innerHTML = `<td><input class="desc" value="${desc}"></td>
          <td class="text-right"><input class="price" type="number" value="${pr}" min="0"></td>
          <td class="text-right"><span class="rowTotal">0.00</span></td>
          <td><button class="remove-btn">‚úï</button></td>`;
      } else {
        const qt = parseFloat(newItemQty.value)||1;
        const ma = parseFloat(newItemMat.value)||0;
        const lb = parseFloat(newItemLab.value)||0;
        tr.innerHTML = `<td><input class="desc" value="${desc}"></td>
          <td class="text-right"><input class="qty" type="number" value="${qt}" min="1"></td>
          <td class="text-right"><input class="mat" type="number" value="${ma}" min="0"></td>
          <td class="text-right"><input class="lab" type="number" value="${lb}" min="0"></td>
          <td class="text-right"><span class="rowTotal">0.00</span></td>
          <td><button class="remove-btn">‚úï</button></td>`;
      }
      tbody.appendChild(tr);
      tr.querySelectorAll('input').forEach(i=>i.oninput=recalc);
      tr.querySelector('.remove-btn').onclick = ()=>{ tr.remove(); recalc(); };
      recordUsage(desc);
      newItemDesc.value=''; recalc();
    };

    anticipoPct.oninput = recalc;

    function recalc(){
      let subtotal=0;
      tbody.querySelectorAll('tr').forEach(r=>{
        const qty=parseFloat(r.querySelector('.qty')?.value||1);
        const mat=parseFloat(r.querySelector('.mat')?.value||0);
        const lab=parseFloat(r.querySelector('.lab')?.value||0);
        const pr =parseFloat(r.querySelector('.price')?.value||0);
        const line = quoteType.value==='express'? pr : (mat+lab)*qty;
        r.querySelector('.rowTotal').textContent = line.toFixed(2);
        subtotal+=line;
      });
      document.getElementById('subtotal').textContent=subtotal.toFixed(2);
      const ivaAmt=withIvaSwitch.checked?subtotal*0.16:0;
      document.getElementById('ivaAmount').textContent=ivaAmt.toFixed(2);
      const total=subtotal+ivaAmt;
      document.getElementById('totalAmount').textContent=total.toFixed(2);
      if (withAnticipoSwitch.checked) {
        const pct=parseFloat(anticipoPct.value)||0;
        anticipoPctDisp.textContent=pct;
        const ant=total*pct/100;
        document.getElementById('anticipoAmount').textContent=ant.toFixed(2);
        document.getElementById('balance').textContent=(total-ant).toFixed(2);
      } else {
        anticipoPctDisp.textContent="0";
        document.getElementById('anticipoAmount').textContent="0.00";
        document.getElementById('balance').textContent=total.toFixed(2);
      }
      buildPreview(previewRes, false);
    }

    function buildPreview(container, isPDF){
      container.innerHTML = '';
      // Header: diferente para PDF vs Web
      if (isPDF) {
        const hdr = document.createElement('div');
        hdr.className = 'header';
        hdr.innerHTML = `
          <div class="logo-title">
            <img src="https://i.imgur.com/kf8e57F.jpg" crossorigin="anonymous">
            <div class="title-groupar"><span class="azul">GRUPO</span> <span class="rojo">AR</span></div>
          </div>
          <div class="datos">
            <div style="font-size:1.08em;"><b>${quoteTitle.value}</b></div>
            <div><strong>Cliente:</strong> ${clientInput.value||'--'}</div>
            <div><strong>Ubicaci√≥n:</strong> ${locationInput.value||'--'}</div>
          </div>
        `;
        container.append(hdr);
      } else {
        const hdr = document.createElement('div');
        hdr.className = 'header';
        hdr.style.marginBottom = "10px";
        hdr.innerHTML = `
          <img src="https://i.imgur.com/kf8e57F.jpg" alt="Logo" style="height:30px;margin-right:8px;">
          <span style="font-weight:500;font-size:1.15em;color:#0a6ec8;">GRUPO <span style="color:#dc1e28">AR</span></span>
        `;
        container.append(hdr);
        const t = document.createElement('div');
        t.innerHTML = `<div style="font-size:1.09em"><b>${quoteTitle.value}</b></div>
        <div style="font-size:.97em"><strong>Cliente:</strong> ${clientInput.value||'--'}<br>
        <strong>Ubicaci√≥n:</strong> ${locationInput.value||'--'}</div>`;
        t.style.marginBottom = "7px";
        container.append(t);
      }
      // Tabla
      const tbl=document.createElement('table');
      const head=quoteType.value==='express'
        ?`<tr><th>Descripci√≥n</th><th>Precio</th><th>Total</th></tr>`
        :`<tr><th>Descripci√≥n</th><th>Cant.</th><th>Material</th><th>Mano Obra</th><th>Total</th></tr>`;
      tbl.innerHTML=`<thead>${head}</thead><tbody></tbody>`;
      const body=tbl.querySelector('tbody');
      tbody.querySelectorAll('tr').forEach(r=>{
        const row=document.createElement('tr');
        Array.from(r.cells).slice(0,-1).forEach(c=>{
          const cl=c.cloneNode(true);
          const inp=cl.querySelector('input'), sp=cl.querySelector('span.rowTotal');
          if(inp) cl.textContent=inp.value;
          else if(sp) cl.textContent=sp.textContent;
          row.append(cl);
        });
        body.append(row);
      });
      container.append(tbl);

      // Summary
      const sum=document.createElement('div'); sum.className='summary';
      sum.innerHTML=`<div>Subtotal: $${document.getElementById('subtotal').textContent}</div>
        <div>IVA: $${document.getElementById('ivaAmount').textContent}</div>
        <div><strong>Total: $${document.getElementById('totalAmount').textContent}</strong></div>`;
      if (withAnticipoSwitch.checked) {
        sum.innerHTML += `<div>Anticipo (${anticipoPctDisp.textContent}%): $${document.getElementById('anticipoAmount').textContent}</div>`;
      }
      sum.innerHTML += `<div><strong>Saldo: $${document.getElementById('balance').textContent}</strong></div>`;
      container.append(sum);

      // Detalles
      const checks=Array.from(document.querySelectorAll('#detailsDrawer input:checked')).map(i=>i.value);
      if(checks.length || detallesArray.length){
        const dt=document.createElement('div');
        dt.innerHTML=`<h4 style="color:#0a6ec8">Detalles y Especificaciones</h4>
        <ul style="margin:4px 0 0 14px;">
        ${checks.map(t=>`<li>${t}</li>`).join('')}
        ${detallesArray.map(t=>`<li>${t}</li>`).join('')}
        </ul>`;
        container.append(dt);
      }

      // Footer solo en PDF
      if(isPDF) {
        const ft=document.createElement('div'); ft.className='footer';
        ft.textContent='GRUPO AR Construcci√≥n y Dise√±o ‚Äî Tel: +52 1 438 134 6142';
        container.append(ft);
      }
    }

    async function generatePDF(){
      buildPreview(previewPDF, true);
      previewPDF.style.display='block';
      const canvas=await html2canvas(previewPDF,{scale:2,useCORS:true, backgroundColor:'#fff'});
      const img=canvas.toDataURL('image/png');
      const { jsPDF }=window.jspdf;
      const pdf=new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
      pdf.addImage(img,'PNG',0,0,210,297);
      previewPDF.style.display='none';
      return pdf;
    }

    document.getElementById('generateBtn').onclick=async()=>{
      const pdf=await generatePDF();
      const fn=(fileNameInput.value.trim()||'cotizacion')+'.pdf';
      pdf.save(fn);
    };
    document.getElementById('shareBtn').onclick=async()=>{
      try{
        const pdf=await generatePDF();
        const blob=pdf.output('blob');
        const file=new File([blob],(fileNameInput.value.trim()||'cotizacion')+'.pdf',{type:'application/pdf'});
        if(navigator.canShare&&navigator.canShare({files:[file]})){
          await navigator.share({files:[file],title:'Cotizaci√≥n Grupo AR'});
        } else {
          pdf.save(file.name);
          alert('PDF listo. Comp√°rtelo manualmente.');
        }
      }catch{ alert('Error al compartir.'); }
    };

    document.addEventListener('DOMContentLoaded', recalc);
  </script>
</body>
</html>
