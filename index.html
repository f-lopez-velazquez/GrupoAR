<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cotizaciones Grupo AR</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --azul: #0a6ec8;
      --rojo: #dc1e28;
      --fondo: #f7fafd;
      --borde: #dde6f5;
      --txt: #212b3c;
      --panel: #fff;
      --input-bg: #fafdff;
      --slide-bg: #d0dbef;
      --slide-active: #4bb450;
      --slide-knob: #fff;
      --slide-off: #c5c5c5;
    }
    body { font-family: 'Inter', Arial, sans-serif; background: var(--fondo);
      color: var(--txt); margin:0; min-height:100vh; font-size: 1.04em;}
    body.dark { --fondo: #171e29; --txt: #e4eaf6; --panel: #232c41; --input-bg: #1e2535;
      --borde: #23304e; --slide-bg: #2a3752; --slide-active: #37cb72; background: var(--fondo); color: var(--txt);}
    .container { max-width: 700px; margin:0 auto 26px auto; padding: 8px;}
    header { display:flex; align-items:center; gap:14px; justify-content:center; margin:24px 0 18px 0;}
    header img { height:50px; border-radius:10px; box-shadow: 0 2px 14px #c6def3;}
    .logoTitle { font-size:1.54em; font-weight:700; color:var(--azul);}
    .logoTitle span { color: var(--rojo);}
    .form-container, .preview-container { background: var(--panel); border-radius: 13px; box-shadow: 0 2px 14px rgba(10,110,200,0.09); padding: 18px 10px 18px 10px; margin-bottom: 20px; }
    .form-row { display:flex; flex-wrap:wrap; gap:10px 13px; margin-bottom: 7px;}
    .form-col { flex:1 1 175px; min-width:130px;}
    label { font-weight: 600; color: var(--azul); display: block; font-size: 1.03em; margin-bottom: 1px; letter-spacing:.1px;}
    body.dark label { color: #7bbcff;}
    .input-wrap { position:relative; margin-bottom:2px;}
    input, select, textarea { width: 100%; box-sizing: border-box; border: 2px solid var(--borde); border-radius: 8px; font-size: 1em; padding: 10px 10px 10px 34px; background: var(--input-bg); color: var(--txt);}
    input:focus, textarea:focus, select:focus { border-color: var(--azul); background: #fff; color: var(--txt);}
    .input-icon { position:absolute; top:50%; left:10px; transform:translateY(-50%); font-size:1.13em; color: #93a5c6;}
    .btn-row { display:flex; gap:10px; margin:9px 0;}
    .btn-main, #generateBtn, #shareBtn { background: linear-gradient(93deg, var(--azul), var(--rojo) 85%); color: #fff; font-size: 1.08em; font-weight: 600; border: none; border-radius: 9px; letter-spacing: .16px; padding: 13px 0; cursor:pointer; width:100%; box-shadow: 0 2px 10px #b6cde948; transition: transform .1s; margin-top: 8px;}
    .btn-main:active, #generateBtn:active, #shareBtn:active { transform: scale(.97);}
    .switch-wrap { display: flex; align-items:center; gap:6px; margin-bottom:5px;}
    .switch { position: relative; display: inline-block; width: 48px; height: 27px; vertical-align: middle;}
    .switch input { opacity:0; width:0; height:0;}
    .slider { position: absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background: var(--slide-bg); border-radius:16px; transition:.18s;}
    .slider:before { position:absolute; content:""; left:4px; top:4px; width:19px; height:19px; background:var(--slide-knob); border-radius:50%; transition:.17s; box-shadow: 0 1px 3px #b7b7b7;}
    input:checked + .slider { background: var(--slide-active);}
    input:checked + .slider:before { transform: translateX(20px);}
    .slide-label {font-size: .97em; font-weight: 500; color: var(--txt);}
    .form-row.switches { gap:18px;}
    h3 { font-size: 1.08em; color: var(--azul);}
    body.dark h3 { color: #7bbcff;}
    /* Tabla de items */
    .table-scroll { overflow-x:auto; border-radius:7px; }
    table { width:100%; border-collapse:collapse; margin-top:6px;}
    th, td { border:1.4px solid var(--borde); padding:10px 6px; font-size:.99em; background:transparent;}
    th { background:linear-gradient(90deg, #e8f2fb 75%, #f9e8ea 100%); color: var(--azul); font-weight: 600;}
    tr { transition: background .2s;}
    tr.row-highlight { background: #d6f3e9 !important; animation:fadeRow .8s 1;}
    @keyframes fadeRow {0%{background:#8be2d7;}100%{background:inherit;}}
    tr:nth-child(even) { background: #f5faff;}
    td input { background:transparent; border:none; border-radius:0; padding:4px; width:96%; font-size:1em;}
    .btn-del { background:none; border:none; color:#c00; font-size:1.15em; cursor:pointer; transition: color .12s; padding:0 8px;}
    .btn-del:hover { color:#dc1e28;}
    .summary { margin-top:10px; text-align:right; font-size:1.01em; color: #384357;}
    body.dark .summary { color: #c7d6ed;}
    .summary strong { font-size:1.14em;}
    .preview-container { margin-top:20px;}
    #previewResponsive { border:1.1px solid #d8e8f4; border-radius:8px; padding:12px; background: #f8fafc; font-size:1.04em; min-height:70px;}
    body.dark #previewResponsive { background: #232c41; border-color:#1d2b44;}
    /* SIDEBAR */
    .sidebar { position:fixed; top:0; right:0; width:340px; max-width:99vw; height:100vh; background:var(--panel); box-shadow: -2px 0 28px #0a6ec81a; z-index:999; transition: transform 0.33s cubic-bezier(.44,0,.2,1); padding:25px 16px 19px 18px; border-radius:13px 0 0 13px; overflow-y:auto; transform:translateX(100%); pointer-events:none;}
    .sidebar.open { transform:translateX(0); pointer-events:auto;}
    .sidebar.closed { transform:translateX(100%); pointer-events:none;}
    .sidebar h4 { color: var(--azul); margin-bottom:13px;}
    .sidebar label { display:flex; align-items:center; gap:8px; font-weight:460; margin-bottom:10px; cursor:pointer; font-size:1.01em;}
    .sidebar textarea { margin-top:6px; min-height:37px; background: #f4f8fd; border:2px solid var(--borde); font-size:1em; margin-bottom:4px; border-radius:7px; }
    .sidebar-close { background:none; border:none; color:var(--azul); font-size:1.5em; position:absolute; top:8px; right:12px; cursor:pointer; border-radius:6px;}
    .detalles-agregados { margin:8px 0 0 0; padding:0; list-style:disc; color:#384357; font-size:1.01em;}
    .detalles-agregados li { margin:2px 0; display:flex; align-items:center; justify-content:space-between; gap:7px; background: #f7fcff; padding:5px 8px; border-radius:5px;}
    .detalles-agregados .del-detalle { color:#c00; background:none; border:none; font-size:1.08em; cursor:pointer; margin-left:8px; border-radius:5px;}
    @media (max-width:700px){
      .container { max-width:99vw; padding:2vw;}
      .form-row { flex-direction:column; gap:4px;}
      .form-col { min-width:90px;}
      .form-container, .preview-container { padding:9px 2px 12px 2px;}
      table, th, td { font-size:.96em;}
      #previewResponsive { font-size:.99em;}
      .sidebar { width:97vw; max-width:99vw; padding-left:2vw; padding-right:2vw;}
    }
    #previewPDF {
      display:none; width:210mm; min-height:297mm; background:#fff; padding:15mm 13mm 18mm 13mm; margin:0 auto;
      font-size:13px; line-height:1.39; position:relative; overflow:hidden; box-shadow:0 1px 38px #b1b9d429;
    }
    #previewPDF .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:13px;}
    #previewPDF .header .logo-title { display:flex; flex-direction:column; align-items:center; gap:8px;}
    #previewPDF .header img { max-width:210px; max-height:110px; display:block; margin:0 auto;}
    #previewPDF .header .title-groupar { font-size:2.2em; font-weight:bold; letter-spacing:1.1px; margin-top:2px;}
    #previewPDF .header .title-groupar .azul { color: #0a6ec8;}
    #previewPDF .header .title-groupar .rojo { color: #dc1e28;}
    #previewPDF .header .datos { text-align:right; font-size:1.14em;}
    #previewPDF th, #previewPDF td { padding:7px; border:1.2px solid #cde0f6; text-align:left; font-size:13px;}
    #previewPDF th { background: #e7f0fa; color:#0a6ec8; letter-spacing:.1px;}
    #previewPDF .summary { text-align:right; font-size:13px; margin-bottom:11px;}
    #previewPDF .firma-simbolica { margin-top:34px; text-align:right;}
    #previewPDF .firma-simbolica svg { width:140px; height:60px; display:block; margin-left:auto; margin-bottom:0;}
    #previewPDF .firma-texto { text-align:right; font-size:11.5px; color:#888; margin-top:2px;}
    #previewPDF .footer { text-align:center; font-size:11.5px; color:#888; border-top:1px solid #ccc; padding-top:8px; position:absolute; bottom:12mm; left:13mm; right:13mm;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://i.imgur.com/kf8e57F.jpg" alt="Logo Grupo AR">
      <div class="logoTitle"><span>GRUPO</span> <span style="color:#dc1e28;">AR</span></div>
    </header>
    <div class="form-container">
      <div class="form-row">
        <div class="form-col">
          <label for="quoteTitle">T√≠tulo de Cotizaci√≥n</label>
          <div class="input-wrap">
            <span class="input-icon">üìù</span>
            <input id="quoteTitle" placeholder="Cotizaci√≥n #1234" value="Cotizaci√≥n probable ‚Äì Nuevo cliente">
          </div>
        </div>
        <div class="form-col">
          <label for="fileName">Nombre de Archivo</label>
          <div class="input-wrap">
            <span class="input-icon">üìÑ</span>
            <input id="fileName" placeholder="cotizacion_1234" value="cotizacion_cliente" readonly>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label for="quoteType">Tipo de Cotizaci√≥n</label>
          <select id="quoteType">
            <option value="express">Expr√©s</option>
            <option value="detailed">Detallada</option>
          </select>
        </div>
        <div class="form-col">
          <label for="client">Cliente</label>
          <div class="input-wrap">
            <span class="input-icon">üë§</span>
            <input id="client" placeholder="Nombre del cliente">
          </div>
        </div>
        <div class="form-col">
          <label for="location">Ubicaci√≥n</label>
          <div class="input-wrap">
            <span class="input-icon">üìç</span>
            <input id="location" placeholder="Direcci√≥n o ubicaci√≥n">
          </div>
        </div>
      </div>
      <div class="form-row switches">
        <div class="switch-wrap">
          <label class="slide-label" for="withIvaSwitch">IVA (16%)</label>
          <label class="switch">
            <input type="checkbox" id="withIvaSwitch" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="switch-wrap">
          <label class="slide-label" for="withAnticipoSwitch">Anticipo</label>
          <label class="switch">
            <input type="checkbox" id="withAnticipoSwitch">
            <span class="slider"></span>
          </label>
        </div>
        <div id="anticipoField" style="display:none;max-width:140px;">
          <label for="anticipoPct" style="font-weight:500;margin-bottom:0;">%</label>
          <div class="input-wrap" style="padding-left:0;">
            <input id="anticipoPct" type="number" min="0" max="100" value="0" style="padding-left:8px;">
          </div>
        </div>
      </div>
      <h3 style="margin:14px 0 6px 0;">Agregar Item</h3>
      <div class="form-row" id="itemInputs">
        <div class="form-col" style="flex:2">
          <label for="newItemDesc">Descripci√≥n</label>
          <div class="input-wrap">
            <span class="input-icon">üîß</span>
            <input id="newItemDesc" placeholder="Ej. Pintura">
          </div>
        </div>
        <div class="form-col" id="expressInputs" style="display:flex;">
          <div style="width:100%">
            <label for="newItemPrice">Precio</label>
            <div class="input-wrap">
              <span class="input-icon">$</span>
              <input id="newItemPrice" type="number" min="0" value="0" placeholder="Precio total">
            </div>
          </div>
        </div>
        <div class="form-col" id="detailedInputs" style="display:none;flex-direction:row;gap:6px;">
          <div>
            <label for="newItemQty">Cantidad</label>
            <div class="input-wrap">
              <span class="input-icon">#</span>
              <input id="newItemQty" type="number" min="1" value="1" placeholder="Cantidad">
            </div>
          </div>
          <div>
            <label for="newItemMat">Material</label>
            <div class="input-wrap">
              <span class="input-icon">$</span>
              <input id="newItemMat" type="number" min="0" value="0" placeholder="Material">
            </div>
          </div>
          <div>
            <label for="newItemLab">Mano Obra</label>
            <div class="input-wrap">
              <span class="input-icon">‚öíÔ∏è</span>
              <input id="newItemLab" type="number" min="0" value="0" placeholder="Mano obra">
            </div>
          </div>
        </div>
        <div style="align-self:flex-end;min-width:110px;">
          <button class="btn-main" id="addItemBtn" style="padding:10px 0;">Agregar</button>
        </div>
      </div>
      <div class="table-scroll">
        <table id="itemsTable">
          <thead id="thead-express">
            <tr><th>Descripci√≥n</th><th>Precio</th><th>Total</th><th></th></tr>
          </thead>
          <thead id="thead-detailed" style="display:none;">
            <tr><th>Descripci√≥n</th><th>Cant.</th><th>Material</th><th>Mano Obra</th><th>Total</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="summary">
        <div>Subtotal: $<span id="subtotal">0.00</span></div>
        <div>IVA: $<span id="ivaAmount">0.00</span></div>
        <div><strong>Total: $<span id="totalAmount">0.00</span></strong></div>
        <div id="anticipoSummary" style="display:none;">Anticipo (<span id="anticipoPctDisplay">0</span>%): $<span id="anticipoAmount">0.00</span></div>
        <div><strong>Saldo: $<span id="balance">0.00</span></strong></div>
      </div>
      <button class="btn-main" style="margin-bottom:4px;" id="openDetails">üõ°Ô∏è Detalles y Especificaciones</button>
    </div>
    <div class="preview-container">
      <h3 style="font-size:1.08em;">Vista Previa (no es el PDF final)</h3>
      <div id="previewResponsive"></div>
      <div style="text-align:center; margin-top:9px;">
        <button class="btn-main" id="generateBtn">Generar PDF</button>
        <button class="btn-main" id="shareBtn">Compartir</button>
      </div>
    </div>
  </div>
  <div class="sidebar closed" id="detailsDrawer" tabindex="-1" aria-modal="true" aria-label="Detalles">
    <button class="sidebar-close" id="closeDetails" title="Cerrar">√ó</button>
    <h4>Detalles y Especificaciones</h4>
    <div class="switch-wrap">
      <label class="slide-label" for="chk1">Pago 50% materiales antes de iniciar</label>
      <label class="switch"><input type="checkbox" id="chk1"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk2">Pago 50% restante al finalizar</label>
      <label class="switch"><input type="checkbox" id="chk2"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk3">Incluye materiales, herramientas y mano de obra</label>
      <label class="switch"><input type="checkbox" id="chk3"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk4">Retiro de escombro incluido</label>
      <label class="switch"><input type="checkbox" id="chk4"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk5">Limpieza general incluida</label>
      <label class="switch"><input type="checkbox" id="chk5"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk6">Garant√≠a de funcionamiento</label>
      <label class="switch"><input type="checkbox" id="chk6"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk7">Garant√≠a en materiales</label>
      <label class="switch"><input type="checkbox" id="chk7"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk8">Vigencia cotizaci√≥n: 30 d√≠as</label>
      <label class="switch"><input type="checkbox" id="chk8"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk9">Responsabilidad terceros</label>
      <label class="switch"><input type="checkbox" id="chk9"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk10">Cumplimiento normativas</label>
      <label class="switch"><input type="checkbox" id="chk10"><span class="slider"></span></label>
    </div>
    <div class="switch-wrap">
      <label class="slide-label" for="chk11">Cl√°usula fuerza mayor</label>
      <label class="switch"><input type="checkbox" id="chk11"><span class="slider"></span></label>
    </div>
    <label style="font-weight:500;margin-top:13px;">Detalles adicionales:</label>
    <textarea id="detalleAdicional" placeholder="Escribe un detalle adicional..."></textarea>
    <button type="button" id="addDetalleBtn" class="btn-main" style="background:#009e47; margin-bottom:9px;">Agregar detalle</button>
    <ul class="detalles-agregados" id="detallesAgregados"></ul>
  </div>
  <div id="previewPDF"></div>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
      document.body.classList.add("dark");
    // SIDEBAR animado
    const openDetailsBtn = document.getElementById('openDetails');
    const closeDetailsBtn = document.getElementById('closeDetails');
    const detailsDrawer = document.getElementById('detailsDrawer');
    function openSidebar() {detailsDrawer.classList.remove('closed');detailsDrawer.classList.add('open');document.body.style.overflow="hidden";setTimeout(()=>detailsDrawer.focus(),250);}
    function closeSidebar() {detailsDrawer.classList.remove('open');detailsDrawer.classList.add('closed');document.body.style.overflow="";}
    openDetailsBtn.onclick = openSidebar; closeDetailsBtn.onclick = closeSidebar;
    document.addEventListener('keydown', e=>{if((detailsDrawer.classList.contains('open'))&&e.key==='Escape') closeSidebar();});
    // Sincronizar nombre de archivo
    function syncTitleFileName() {
      let t = document.getElementById('quoteTitle').value.toLowerCase().replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'_');
      document.getElementById('fileName').value = t || "cotizacion";
    }
    document.getElementById('quoteTitle').addEventListener('input', syncTitleFileName);
    document.addEventListener('DOMContentLoaded', syncTitleFileName);
    // Tipo cotizaci√≥n
    const quoteType = document.getElementById('quoteType');
    const expressInputs = document.getElementById('expressInputs');
    const detailedInputs = document.getElementById('detailedInputs');
    const theadExpress = document.getElementById('thead-express');
    const theadDetailed = document.getElementById('thead-detailed');
    function updateTypeUI() {
      if (quoteType.value === "express") {
        expressInputs.style.display = "flex";
        detailedInputs.style.display = "none";
        theadExpress.style.display = "";
        theadDetailed.style.display = "none";
      } else {
        expressInputs.style.display = "none";
        detailedInputs.style.display = "flex";
        theadExpress.style.display = "none";
        theadDetailed.style.display = "";
      }
      renderTable();
    }
    quoteType.onchange = updateTypeUI;
    updateTypeUI();
    // Array para items
    let items = [];
    // Agregar item
    document.getElementById('addItemBtn').onclick = ()=>{
      let desc = document.getElementById('newItemDesc').value.trim();
      if(!desc) return document.getElementById('newItemDesc').focus();
      if(quoteType.value==='express'){
        let pr = parseFloat(document.getElementById('newItemPrice').value)||0;
        items.push({desc, pr});
      } else {
        let qt = parseFloat(document.getElementById('newItemQty').value)||1;
        let ma = parseFloat(document.getElementById('newItemMat').value)||0;
        let lb = parseFloat(document.getElementById('newItemLab').value)||0;
        items.push({desc, qt, ma, lb});
      }
      // Limpiar y enfocar siguiente
      document.getElementById('newItemDesc').value='';
      document.getElementById('newItemPrice').value='0';
      document.getElementById('newItemQty').value='1';
      document.getElementById('newItemMat').value='0';
      document.getElementById('newItemLab').value='0';
      document.getElementById('newItemDesc').focus();
      renderTable();
      recalc();
    };
    // Render tabla segun tipo
    function renderTable(){
      const tbody = document.querySelector('#itemsTable tbody');
      tbody.innerHTML = '';
      items.forEach((item, idx)=>{
        let tr = document.createElement('tr'); tr.className = 'row-highlight';
        setTimeout(()=>tr.classList.remove('row-highlight'),700);
        if(quoteType.value==='express'){
          let pr = item.pr||0;
          let total = pr.toFixed(2);
          tr.innerHTML = `<td>${item.desc}</td>
            <td>$${pr.toFixed(2)}</td>
            <td>$${total}</td>
            <td><button class="btn-del" data-idx="${idx}">‚úï</button></td>`;
        } else {
          let qt = item.qt||1, ma = item.ma||0, lb = item.lb||0;
          let total = ((ma+lb)*qt).toFixed(2);
          tr.innerHTML = `<td>${item.desc}</td>
            <td>${qt}</td>
            <td>$${ma.toFixed(2)}</td>
            <td>$${lb.toFixed(2)}</td>
            <td>$${total}</td>
            <td><button class="btn-del" data-idx="${idx}">‚úï</button></td>`;
        }
        tbody.appendChild(tr);
        tr.querySelector('.btn-del').onclick = ()=>{ items.splice(idx,1); renderTable(); recalc(); };
      });
      recalc();
    }
    // Calculo total
    function recalc(){
      let subtotal=0;
      if(quoteType.value==="express"){
        items.forEach(item=>{subtotal+=item.pr||0;});
      } else {
        items.forEach(item=>{subtotal+=((item.ma||0)+(item.lb||0))*(item.qt||1);});
      }
      document.getElementById('subtotal').textContent=subtotal.toFixed(2);
      const ivaAmt=document.getElementById('withIvaSwitch').checked?subtotal*0.16:0;
      document.getElementById('ivaAmount').textContent=ivaAmt.toFixed(2);
      const total=subtotal+ivaAmt;
      document.getElementById('totalAmount').textContent=total.toFixed(2);
      const anticipo = document.getElementById('withAnticipoSwitch').checked ? parseFloat(document.getElementById('anticipoPct').value)||0 : 0;
      document.getElementById('anticipoSummary').style.display = anticipo ? "" : "none";
      document.getElementById('anticipoPctDisplay').textContent=anticipo;
      document.getElementById('anticipoAmount').textContent=(total*anticipo/100).toFixed(2);
      document.getElementById('balance').textContent=(total-total*anticipo/100).toFixed(2);
      buildPreview(previewRes, false);
    }
    document.getElementById('withIvaSwitch').onchange = recalc;
    document.getElementById('withAnticipoSwitch').onchange = function(){
      document.getElementById('anticipoField').style.display = this.checked ? "" : "none";
      recalc();
    };
    document.getElementById('anticipoPct').oninput = recalc;
    // Detalles y especificaciones
    const detallesArray = [];
    document.getElementById('addDetalleBtn').onclick = function() {
      let txt = document.getElementById('detalleAdicional').value.trim();
      if(!txt) return;
      detallesArray.push(txt);
      document.getElementById('detalleAdicional').value = "";
      renderDetalles();
    };
    function renderDetalles() {
      const detallesAgregados = document.getElementById('detallesAgregados');
      detallesAgregados.innerHTML = '';
      detallesArray.forEach((t,idx)=>{
        const li = document.createElement('li');
        li.textContent = t;
        const btn = document.createElement('button');
        btn.textContent = "‚úï";
        btn.className = "del-detalle";
        btn.onclick = ()=>{ detallesArray.splice(idx,1); renderDetalles(); };
        li.appendChild(btn);
        detallesAgregados.appendChild(li);
      });
    }
    // Vista previa
    function buildPreview(container, isPDF){
      container.innerHTML = '';
      // Header
      if (isPDF) {
        const hdr = document.createElement('div');
        hdr.className = 'header';
        hdr.innerHTML = `
          <div class="logo-title">
            <img src="https://i.imgur.com/kf8e57F.jpg" crossorigin="anonymous">
            <div class="title-groupar"><span class="azul">GRUPO</span> <span class="rojo">AR</span></div>
          </div>
          <div class="datos">
            <div style="font-size:1.17em; font-weight:bold"><b>${document.getElementById('quoteTitle').value}</b></div>
            <div><strong>Cliente:</strong> ${document.getElementById('client').value||'--'}</div>
            <div><strong>Ubicaci√≥n:</strong> ${document.getElementById('location').value||'--'}</div>
          </div>
        `;
        container.append(hdr);
      } else {
        const hdr = document.createElement('div');
        hdr.className = 'header';
        hdr.innerHTML = `
          <img src="https://i.imgur.com/kf8e57F.jpg" alt="Logo" style="height:32px;margin-right:10px;">
          <span style="font-weight:600;font-size:1.16em;color:#0a6ec8;">GRUPO <span style="color:#dc1e28">AR</span></span>
        `;
        container.append(hdr);
        const t = document.createElement('div');
        t.innerHTML = `<div style="font-size:1.09em"><b>${document.getElementById('quoteTitle').value}</b></div>
        <div style="font-size:.98em"><strong>Cliente:</strong> ${document.getElementById('client').value||'--'}<br>
        <strong>Ubicaci√≥n:</strong> ${document.getElementById('location').value||'--'}</div>`;
        t.style.marginBottom = "6px";
        container.append(t);
      }
      // Tabla
      const tbl=document.createElement('table');
      if(quoteType.value==="express"){
        tbl.innerHTML=`<thead><tr><th>Descripci√≥n</th><th>Precio</th><th>Total</th></tr></thead><tbody></tbody>`;
        const body=tbl.querySelector('tbody');
        items.forEach(item=>{
          let tr = document.createElement('tr');
          let pr = item.pr||0, total = pr.toFixed(2);
          tr.innerHTML = `<td>${item.desc}</td><td>$${pr.toFixed(2)}</td><td>$${total}</td>`;
          body.appendChild(tr);
        });
      } else {
        tbl.innerHTML=`<thead><tr><th>Descripci√≥n</th><th>Cant.</th><th>Material</th><th>Mano Obra</th><th>Total</th></tr></thead><tbody></tbody>`;
        const body=tbl.querySelector('tbody');
        items.forEach(item=>{
          let qt = item.qt||1, ma = item.ma||0, lb = item.lb||0;
          let total = ((ma+lb)*qt).toFixed(2);
          let tr = document.createElement('tr');
          tr.innerHTML = `<td>${item.desc}</td><td>${qt}</td><td>$${ma.toFixed(2)}</td><td>$${lb.toFixed(2)}</td><td>$${total}</td>`;
          body.appendChild(tr);
        });
      }
      container.append(tbl);
      // Summary
      const sum=document.createElement('div'); sum.className='summary';
      sum.innerHTML=`<div>Subtotal: $${document.getElementById('subtotal').textContent}</div>
        <div>IVA: $${document.getElementById('ivaAmount').textContent}</div>
        <div><strong>Total: $${document.getElementById('totalAmount').textContent}</strong></div>`;
      const anticipo = document.getElementById('withAnticipoSwitch').checked ? parseFloat(document.getElementById('anticipoPct').value)||0 : 0;
      if (anticipo) {
        sum.innerHTML += `<div>Anticipo (${anticipo}%): $${document.getElementById('anticipoAmount').textContent}</div>`;
      }
      sum.innerHTML += `<div><strong>Saldo: $${document.getElementById('balance').textContent}</strong></div>`;
      container.append(sum);
      // Detalles y especificaciones
      let checks=[];
      for(let i=1;i<=11;i++){
        if(document.getElementById('chk'+i).checked) checks.push(document.querySelector('label[for=chk'+i+']').innerText);
      }
      if(checks.length || detallesArray.length){
        const dt=document.createElement('div');
        dt.innerHTML=`<h4 style="color:#0a6ec8">Detalles y Especificaciones</h4>
        <ul style="margin:4px 0 0 14px;">
        ${checks.map(t=>`<li>${t}</li>`).join('')}
        ${detallesArray.map(t=>`<li>${t}</li>`).join('')}
        </ul>`;
        container.append(dt);
      }
      // Firma simb√≥lica s√≥lo PDF
      if(isPDF) {
        const f=document.createElement('div');
        f.className='firma-simbolica';
        f.innerHTML = `
          <div>
            <svg viewBox="0 0 160 55">
              <path d="M13,45 Q28,13 57,43 Q75,56 88,37 Q95,26 102,30 Q119,43 124,31 Q128,22 145,18" fill="none" stroke="#0a6ec8" stroke-width="2.3"/>
              <text x="7" y="52" fill="#0a6ec8" font-family="cursive" font-size="30" font-weight="bold">Grupo AR</text>
            </svg>
          </div>
          <div class="firma-texto">Firma simb√≥lica. Este documento no requiere firma aut√≥grafa para su validez.</div>
        `;
        container.append(f);
      }
      // Footer s√≥lo PDF
      if(isPDF) {
        const ft=document.createElement('div'); ft.className='footer';
        ft.textContent='GRUPO AR Construcci√≥n y Dise√±o ‚Äî Tel: +52 1 438 134 6142';
        container.append(ft);
      }
    }
    // GENERAR PDF ULTRA LIGERO
    document.getElementById('generateBtn').onclick = async ()=>{
      buildPreview(previewPDF, true);
      previewPDF.style.display='block';
      let pdf = new window.jspdf.jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
      // Marca de agua
      let watermark = "https://i.imgur.com/kf8e57F.jpg";
      let img = new Image(); img.src = watermark;
      await new Promise(r=>{img.onload=r;});
      pdf.addImage(img,"JPEG",35,80,140,140,"","FAST",0.06);
      await pdf.html(previewPDF, {
        margin:[15,13,25,13],
        autoPaging: true,
        html2canvas: { scale:1.25, backgroundColor:'#fff', useCORS:true }
      });
      previewPDF.style.display='none';
      pdf.save((document.getElementById('fileName').value||'cotizacion')+'.pdf');
    };
    document.getElementById('shareBtn').onclick=async()=>{
      alert('Usa "Generar PDF" y comp√°rtelo manualmente.');
    };
    document.addEventListener('DOMContentLoaded', ()=>{
      renderTable();
      recalc();
    });
  </script>
</body>
</html>
